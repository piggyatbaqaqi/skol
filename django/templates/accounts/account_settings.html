{% extends "accounts/base.html" %}
{% load socialaccount %}

{% block title %}Account Settings - SKOL{% endblock %}

{% block content %}
<h1>Account Settings</h1>
<p class="subtitle">Manage your account and login methods</p>

<!-- Account Info Section -->
<div class="settings-section">
    <h2>Account Information</h2>

    <form id="username-form" method="post" action="{% url 'accounts:account_settings' %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="change_username">

        {% if username_form.errors %}
        <div class="error">
            {% for field in username_form %}
                {% for error in field.errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            {% endfor %}
        </div>
        {% endif %}

        <div class="info-row">
            <span class="info-label">Username:</span>
            <span class="info-value" style="display: flex; align-items: center; gap: 6px;">
                <input type="text" name="username" id="username-input"
                       value="{{ user.username }}"
                       class="form-input" readonly
                       style="width: 200px; display: inline-block;">
                <button type="button" id="username-lock-btn"
                        class="lock-btn" title="Click to edit username"
                        onclick="unlockUsername()">
                    <svg id="lock-icon" viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2z"/>
                    </svg>
                    <svg id="unlock-icon" viewBox="0 0 24 24" width="18" height="18" fill="currentColor" style="display:none;">
                        <path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z"/>
                    </svg>
                </button>
                <button type="button" id="username-cancel-btn"
                        class="lock-btn" title="Cancel"
                        style="display:none;"
                        onclick="lockUsername()">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </span>
        </div>
    </form>

    <!-- Confirmation dialog -->
    <dialog id="username-confirm-dialog" class="confirm-dialog">
        <p>Are you sure you want to change your username?</p>
        <p style="font-size: 0.85em; color: #666; margin-top: 8px;">
            Bookmarks and links that use your old username will stop working.
        </p>
        <div style="display: flex; gap: 8px; margin-top: 16px; justify-content: flex-end;">
            <button type="button" onclick="this.closest('dialog').close('cancel')"
                    style="padding: 6px 16px; border: 1px solid #ccc; border-radius: 4px; background: white; cursor: pointer;">
                Cancel
            </button>
            <button type="button" onclick="this.closest('dialog').close('confirm')"
                    style="padding: 6px 16px; border: 1px solid #667eea; border-radius: 4px; background: #667eea; color: white; cursor: pointer;">
                Edit Username
            </button>
        </div>
    </dialog>

    <div class="info-row">
        <span class="info-label">Email:</span>
        <span class="info-value">{{ user.email }}</span>
    </div>
    <div class="info-row">
        <span class="info-label">Member since:</span>
        <span class="info-value">{{ user.date_joined|date:"F j, Y" }}</span>
    </div>
</div>

<!-- Password Change Section -->
<div class="settings-section">
    <h2>Change Password</h2>
    {% if has_usable_password %}
    <form method="post" action="{% url 'accounts:account_settings' %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="change_password">

        {% if password_form.errors %}
        <div class="error">
            {% for field in password_form %}
                {% for error in field.errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            {% endfor %}
            {% for error in password_form.non_field_errors %}
                <p>{{ error }}</p>
            {% endfor %}
        </div>
        {% endif %}

        <div class="form-group">
            <label for="id_old_password">Current Password</label>
            <input type="password" name="old_password" id="id_old_password" class="form-input" required>
        </div>

        <div class="form-group">
            <label for="id_new_password1">New Password</label>
            <input type="password" name="new_password1" id="id_new_password1" class="form-input" required>
        </div>

        <div class="form-group">
            <label for="id_new_password2">Confirm New Password</label>
            <input type="password" name="new_password2" id="id_new_password2" class="form-input" required>
        </div>

        <button type="submit">Change Password</button>
    </form>
    {% else %}
    <div class="info">
        <p>You signed up using a social account and don't have a password set.</p>
        <p>You can set a password to enable email/password login as an alternative.</p>
    </div>
    <form method="post" action="{% url 'accounts:account_settings' %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="set_password">

        {% if set_password_form.errors %}
        <div class="error">
            {% for field in set_password_form %}
                {% for error in field.errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            {% endfor %}
        </div>
        {% endif %}

        <div class="form-group">
            <label for="id_new_password1">New Password</label>
            <input type="password" name="new_password1" id="id_new_password1" class="form-input" required>
        </div>

        <div class="form-group">
            <label for="id_new_password2">Confirm New Password</label>
            <input type="password" name="new_password2" id="id_new_password2" class="form-input" required>
        </div>

        <button type="submit">Set Password</button>
    </form>
    {% endif %}
</div>

<!-- Connected Accounts Section -->
<div class="settings-section">
    <h2>Connected Accounts</h2>
    <p class="section-description">Link social accounts to sign in with them</p>

    {% if social_accounts %}
    <div class="connected-list">
        {% for account in social_accounts %}
        <div class="connection-item">
            <div class="connection-info">
                <span class="provider-badge provider-{{ account.provider }}">
                    {% if account.provider == 'github' %}
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                        GitHub
                    {% elif account.provider == 'google' %}
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        Google
                    {% elif account.provider == 'orcid' %}
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.372 0 0 5.372 0 12s5.372 12 12 12 12-5.372 12-12S18.628 0 12 0zM7.369 4.378c.525 0 .947.431.947.947s-.422.947-.947.947a.95.95 0 0 1-.947-.947c0-.525.422-.947.947-.947zm-.722 3.038h1.444v10.041H6.647V7.416zm3.562 0h3.9c3.712 0 5.344 2.653 5.344 5.025 0 2.578-2.016 5.025-5.325 5.025h-3.919V7.416zm1.444 1.303v7.444h2.297c3.272 0 4.022-2.484 4.022-3.722 0-1.209-.741-3.722-3.853-3.722h-2.466z"/></svg>
                        ORCID
                    {% elif account.provider == 'inaturalist' %}
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.383 0 0 5.383 0 12s5.383 12 12 12 12-5.383 12-12S18.617 0 12 0zm0 2.4c5.302 0 9.6 4.298 9.6 9.6s-4.298 9.6-9.6 9.6S2.4 17.302 2.4 12 6.698 2.4 12 2.4zm0 3.6c-3.314 0-6 2.686-6 6s2.686 6 6 6 6-2.686 6-6-2.686-6-6-6zm0 2.4c1.988 0 3.6 1.612 3.6 3.6s-1.612 3.6-3.6 3.6-3.6-1.612-3.6-3.6 1.612-3.6 3.6-3.6z"/></svg>
                        iNaturalist
                    {% else %}
                        {{ account.provider|title }}
                    {% endif %}
                </span>
                <span class="connection-uid">{{ account.uid }}</span>
            </div>
            <form method="post" action="{% url 'socialaccount_connections' %}" style="margin: 0;">
                {% csrf_token %}
                <input type="hidden" name="account" value="{{ account.id }}">
                <button type="submit" name="action_remove" class="btn-disconnect">Disconnect</button>
            </form>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="no-connections">
        <p>No social accounts connected yet.</p>
    </div>
    {% endif %}

    <div class="connect-new-section">
        <h3>Connect New Account</h3>
        {% get_providers as socialaccount_providers %}
        <div class="social-buttons">
            {% for provider in socialaccount_providers %}
                {% if provider.id == 'github' %}
                    <a href="{% provider_login_url provider.id process='connect' %}" class="btn-social btn-github">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                        Connect GitHub
                    </a>
                {% elif provider.id == 'google' %}
                    <a href="{% provider_login_url provider.id process='connect' %}" class="btn-social btn-google">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        Connect Google
                    </a>
                {% elif provider.id == 'orcid' %}
                    <a href="{% provider_login_url provider.id process='connect' %}" class="btn-social btn-orcid">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.372 0 0 5.372 0 12s5.372 12 12 12 12-5.372 12-12S18.628 0 12 0zM7.369 4.378c.525 0 .947.431.947.947s-.422.947-.947.947a.95.95 0 0 1-.947-.947c0-.525.422-.947.947-.947zm-.722 3.038h1.444v10.041H6.647V7.416zm3.562 0h3.9c3.712 0 5.344 2.653 5.344 5.025 0 2.578-2.016 5.025-5.325 5.025h-3.919V7.416zm1.444 1.303v7.444h2.297c3.272 0 4.022-2.484 4.022-3.722 0-1.209-.741-3.722-3.853-3.722h-2.466z"/></svg>
                        Connect ORCID
                    </a>
                {% elif provider.id == 'inaturalist' %}
                    <span class="btn-social btn-inaturalist disabled" title="Coming soon">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.383 0 0 5.383 0 12s5.383 12 12 12 12-5.383 12-12S18.617 0 12 0zm0 2.4c5.302 0 9.6 4.298 9.6 9.6s-4.298 9.6-9.6 9.6S2.4 17.302 2.4 12 6.698 2.4 12 2.4zm0 3.6c-3.314 0-6 2.686-6 6s2.686 6 6 6 6-2.686 6-6-2.686-6-6-6zm0 2.4c1.988 0 3.6 1.612 3.6 3.6s-1.612 3.6-3.6 3.6-3.6-1.612-3.6-3.6 1.612-3.6 3.6-3.6z"/></svg>
                        Connect iNaturalist (coming soon)
                    </span>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<!-- Download My Data Section -->
<div class="settings-section">
    <h2>Download My Data</h2>
    <p class="section-description">
        Download a ZIP file containing all your data: account info, settings,
        collections, search history, and discussion threads you've participated in.
    </p>
    <a href="{% url 'accounts:export_my_data' %}" class="btn-download">
        Download My Data
    </a>
</div>

<div class="links">
    <p><a href="{{ SCRIPT_NAME }}/">Back to search</a></p>
</div>

<style>
    .container {
        max-width: 600px;
    }

    .settings-section {
        margin-bottom: 30px;
        padding-bottom: 25px;
        border-bottom: 1px solid #e0e0e0;
    }

    .settings-section:last-of-type {
        border-bottom: none;
    }

    .settings-section h2 {
        font-size: 1.2em;
        color: #333;
        margin-bottom: 15px;
    }

    .section-description {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 15px;
    }

    .info-row {
        display: flex;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-label {
        font-weight: 600;
        color: #555;
        width: 140px;
        flex-shrink: 0;
    }

    .info-value {
        color: #333;
    }

    .connected-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 20px;
    }

    .connection-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
    }

    .connection-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .provider-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.9em;
        font-weight: 500;
        color: white;
    }

    .provider-badge svg {
        width: 16px;
        height: 16px;
    }

    .provider-github {
        background: #24292e;
    }

    .provider-google {
        background: #4285f4;
    }

    .provider-orcid {
        background: #a6ce39;
    }

    .provider-inaturalist {
        background: #74ac00;
    }

    .connection-uid {
        color: #666;
        font-size: 0.85em;
    }

    .btn-disconnect {
        padding: 6px 12px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 0.85em;
        cursor: pointer;
        transition: background 0.2s;
    }

    .btn-disconnect:hover {
        background: #c82333;
        transform: none;
        box-shadow: none;
    }

    .no-connections {
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        text-align: center;
        color: #666;
        margin-bottom: 20px;
    }

    .connect-new-section {
        margin-top: 20px;
    }

    .connect-new-section h3 {
        font-size: 1em;
        color: #555;
        margin-bottom: 12px;
    }

    /* Lock/unlock button for username */
    .lock-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 30px;
        padding: 0;
        border: none;
        border-radius: 4px;
        background: transparent;
        color: #888;
        cursor: pointer;
        transition: color 0.2s;
    }

    .lock-btn:hover {
        color: #667eea;
    }

    #username-input[readonly] {
        background: #f5f5f5;
        color: #666;
        border-color: transparent;
    }

    /* Download button */
    .btn-download {
        display: inline-block;
        padding: 8px 20px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 0.9em;
        text-decoration: none;
        cursor: pointer;
        transition: background 0.2s;
    }

    .btn-download:hover {
        background: #5a6fd6;
    }

    /* Confirmation dialog */
    .confirm-dialog {
        border: none;
        border-radius: 8px;
        padding: 24px;
        max-width: 380px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .confirm-dialog::backdrop {
        background: rgba(0, 0, 0, 0.4);
    }

    .confirm-dialog p:first-child {
        font-weight: 600;
        font-size: 1em;
    }
</style>

<script>
    var originalUsername = "{{ user.username|escapejs }}";

    function unlockUsername() {
        var dialog = document.getElementById('username-confirm-dialog');
        dialog.showModal();
        dialog.addEventListener('close', function handler() {
            dialog.removeEventListener('close', handler);
            if (dialog.returnValue === 'confirm') {
                activateEdit();
            }
        });
    }

    function activateEdit() {
        var input = document.getElementById('username-input');
        var lockIcon = document.getElementById('lock-icon');
        var unlockIcon = document.getElementById('unlock-icon');
        var lockBtn = document.getElementById('username-lock-btn');
        var cancelBtn = document.getElementById('username-cancel-btn');

        input.removeAttribute('readonly');
        input.style.background = '';
        input.style.color = '';
        input.focus();
        input.select();

        lockIcon.style.display = 'none';
        unlockIcon.style.display = '';
        lockBtn.title = 'Save username';
        lockBtn.onclick = submitUsername;

        cancelBtn.style.display = '';
    }

    function lockUsername() {
        var input = document.getElementById('username-input');
        var lockIcon = document.getElementById('lock-icon');
        var unlockIcon = document.getElementById('unlock-icon');
        var lockBtn = document.getElementById('username-lock-btn');
        var cancelBtn = document.getElementById('username-cancel-btn');

        input.value = originalUsername;
        input.setAttribute('readonly', '');
        lockIcon.style.display = '';
        unlockIcon.style.display = 'none';
        lockBtn.title = 'Click to edit username';
        lockBtn.onclick = unlockUsername;

        cancelBtn.style.display = 'none';
    }

    function submitUsername() {
        var input = document.getElementById('username-input');
        if (input.value.trim() === '' || input.value === originalUsername) {
            lockUsername();
            return;
        }
        document.getElementById('username-form').submit();
    }

    // If the page reloaded with validation errors, start in edit mode
    {% if username_form.errors %}
    activateEdit();
    {% endif %}
</script>
{% endblock %}
