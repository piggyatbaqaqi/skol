{% extends "accounts/base.html" %}

{% block title %}Feedback - SKOL{% endblock %}

{% block content %}
<h1>Send Feedback</h1>
<p class="subtitle">Report a bug, request a feature, or share your thoughts.</p>

{% if has_github %}
<div class="info github-notice">
    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
    Your feedback will be submitted as a GitHub issue for better tracking.
</div>
{% endif %}

{% if form.errors %}
<div class="error">
    Please correct the errors below.
</div>
{% endif %}

<form method="post" id="feedback-form">
    {% csrf_token %}
    {{ form.browser_info }}

    {% if not has_github %}
    <div class="form-group">
        {{ form.email.label_tag }}
        {{ form.email }}
        {% if form.email.help_text %}
        <p class="helptext">{{ form.email.help_text }}</p>
        {% endif %}
        {{ form.email.errors }}
    </div>
    {% endif %}

    <div class="form-group">
        {{ form.page_url.label_tag }}
        {{ form.page_url }}
        {% if form.page_url.help_text %}
        <p class="helptext">{{ form.page_url.help_text }}</p>
        {% endif %}
        {{ form.page_url.errors }}
    </div>

    <div class="form-group">
        {{ form.feedback_type.label_tag }}
        {{ form.feedback_type }}
        {{ form.feedback_type.errors }}
    </div>

    <div class="form-group">
        {{ form.message.label_tag }}
        {{ form.message }}
        {{ form.message.errors }}
    </div>

    <button type="submit">{% if has_github %}Create GitHub Issue{% else %}Submit Feedback{% endif %}</button>
</form>

<div class="links">
    {% if not has_github and user.is_authenticated %}
    <p class="helptext">
        <a href="{% url 'accounts:account_settings' %}">Connect your GitHub account</a> to submit feedback as GitHub issues.
    </p>
    {% endif %}
    <p><a href="{{ SCRIPT_NAME }}/">Back to Home</a></p>
</div>

<script>
(function() {
    // Collect browser and environment information
    function collectBrowserInfo() {
        const info = {
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            languages: navigator.languages ? navigator.languages.join(', ') : navigator.language,
            screenWidth: screen.width,
            screenHeight: screen.height,
            screenColorDepth: screen.colorDepth,
            viewportWidth: window.innerWidth,
            viewportHeight: window.innerHeight,
            devicePixelRatio: window.devicePixelRatio || 1,
            touchSupport: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
            maxTouchPoints: navigator.maxTouchPoints || 0,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            timezoneOffset: new Date().getTimezoneOffset(),
            cookiesEnabled: navigator.cookieEnabled,
            online: navigator.onLine,
        };

        // Connection info (if available)
        if (navigator.connection) {
            info.connectionType = navigator.connection.effectiveType || 'unknown';
            info.connectionDownlink = navigator.connection.downlink;
            info.connectionSaveData = navigator.connection.saveData || false;
        }

        // Device memory (if available)
        if (navigator.deviceMemory) {
            info.deviceMemory = navigator.deviceMemory + ' GB';
        }

        // Hardware concurrency (CPU cores)
        if (navigator.hardwareConcurrency) {
            info.cpuCores = navigator.hardwareConcurrency;
        }

        // Parse user agent for readable browser/OS info
        const ua = navigator.userAgent;
        if (/Android/i.test(ua)) {
            info.os = 'Android';
            const match = ua.match(/Android\s([0-9.]+)/);
            if (match) info.osVersion = match[1];
        } else if (/iPhone|iPad|iPod/i.test(ua)) {
            info.os = 'iOS';
            const match = ua.match(/OS\s([0-9_]+)/);
            if (match) info.osVersion = match[1].replace(/_/g, '.');
        } else if (/Windows/i.test(ua)) {
            info.os = 'Windows';
        } else if (/Mac OS X/i.test(ua)) {
            info.os = 'macOS';
        } else if (/Linux/i.test(ua)) {
            info.os = 'Linux';
        }

        // Browser detection
        if (/Firefox/i.test(ua)) {
            info.browser = 'Firefox';
        } else if (/Edg/i.test(ua)) {
            info.browser = 'Edge';
        } else if (/Chrome/i.test(ua) && !/Chromium/i.test(ua)) {
            info.browser = 'Chrome';
        } else if (/Safari/i.test(ua) && !/Chrome/i.test(ua)) {
            info.browser = 'Safari';
        } else if (/Opera|OPR/i.test(ua)) {
            info.browser = 'Opera';
        }

        // Mobile detection
        info.isMobile = /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);

        return info;
    }

    // Populate the hidden field on page load
    document.addEventListener('DOMContentLoaded', function() {
        const browserInfoField = document.getElementById('browser_info');
        if (browserInfoField) {
            browserInfoField.value = JSON.stringify(collectBrowserInfo());
        }
    });
})();
</script>
{% endblock %}
