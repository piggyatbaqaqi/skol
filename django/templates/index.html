{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKOL Semantic Search</title>
    <link rel="icon" type="image/png" href="{% static 'favicon.png' %}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .search-form {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        textarea, select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        textarea:focus, select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .inline-group {
            display: flex;
            gap: 20px;
        }

        .inline-group .form-group {
            flex: 1;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 500;
        }

        .error {
            background: #fee;
            border: 2px solid #fcc;
            border-radius: 6px;
            padding: 15px;
            color: #c33;
            margin-bottom: 20px;
        }

        .success {
            background: #efe;
            border: 2px solid #cfc;
            border-radius: 6px;
            padding: 15px;
            color: #393;
            margin-bottom: 20px;
        }

        .results {
            margin-top: 30px;
        }

        .result-card {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .result-title {
            color: #333;
            font-size: 1.3em;
            font-weight: 600;
            flex: 1;
        }

        .similarity-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 15px;
        }

        .result-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #666;
        }

        .meta-item {
            display: flex;
            align-items: center;
        }

        .meta-label {
            font-weight: 600;
            margin-right: 5px;
        }

        .result-description {
            color: #444;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .result-json {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }

        .toggle-json {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-top: 10px;
        }

        .toggle-json:hover {
            background: #e8e8e8;
            transform: none;
            box-shadow: none;
        }

        .view-pdf-btn {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-top: 10px;
            margin-right: 10px;
            text-decoration: none;
            display: inline-block;
        }

        .view-pdf-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
            transform: none;
            box-shadow: none;
            color: white;
        }

        .save-collection-btn {
            background: linear-gradient(135deg, #f0ad4e 0%, #ec971f 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
        }

        .save-collection-btn:hover {
            background: linear-gradient(135deg, #ec971f 0%, #d58512 100%);
            transform: none;
            box-shadow: none;
        }

        .result-actions {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1em;
        }

        .user-navbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }

        .user-navbar a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.2s;
        }

        .user-navbar a:hover {
            color: #764ba2;
        }

        /* Collections dropdown styles */
        .collections-dropdown {
            position: relative;
            display: inline-block;
        }

        .collections-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
            border: none;
        }

        .collections-btn:hover {
            transform: none;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .collections-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            min-width: 250px;
            max-width: 350px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            margin-top: 5px;
        }

        .collections-menu.show {
            display: block;
        }

        .collections-menu-header {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collections-menu-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .collection-menu-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .collection-menu-item:hover {
            background: #f5f5f5;
        }

        .collection-menu-item:last-child {
            border-bottom: none;
        }

        .collection-menu-item .collection-name {
            font-weight: 500;
            color: #333;
        }

        .collection-menu-item .collection-meta {
            font-size: 0.85em;
            color: #666;
            margin-top: 3px;
        }

        .new-collection-btn {
            display: block;
            width: 100%;
            padding: 12px 15px;
            background: #f9f9f9;
            border: none;
            border-top: 1px solid #e0e0e0;
            color: #667eea;
            font-weight: 500;
            cursor: pointer;
            text-align: left;
            border-radius: 0 0 8px 8px;
        }

        .new-collection-btn:hover {
            background: #f0f0f0;
            transform: none;
            box-shadow: none;
        }

        .no-collections {
            padding: 20px 15px;
            color: #666;
            text-align: center;
            font-size: 0.9em;
        }

        /* Settings hamburger menu */
        .settings-dropdown {
            position: relative;
            display: inline-block;
        }

        .settings-btn {
            background: transparent;
            color: #667eea;
            padding: 8px;
            border-radius: 4px;
            font-size: 1.4em;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            line-height: 1;
            transition: background 0.2s, border-color 0.2s;
        }

        .settings-btn:hover {
            background: #f5f5f5;
            border-color: #667eea;
            transform: none;
            box-shadow: none;
        }

        .settings-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            min-width: 280px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            margin-top: 5px;
            padding: 15px;
        }

        .settings-menu.show {
            display: block;
        }

        .settings-menu-header {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .settings-menu .form-group {
            margin-bottom: 15px;
        }

        .settings-menu .form-group:last-child {
            margin-bottom: 0;
        }

        .settings-menu label {
            font-size: 0.9em;
            color: #555;
        }

        .settings-menu select,
        .settings-menu input {
            font-size: 0.9em;
            padding: 8px 10px;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-cancel-btn {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }

        .modal-cancel-btn:hover {
            background: #e8e8e8;
            transform: none;
            box-shadow: none;
        }

        /* Identifier form styles */
        .identifier-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .identifier-list {
            margin-bottom: 15px;
        }

        .identifier-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .identifier-link {
            color: #667eea;
            text-decoration: none;
        }

        .identifier-link:hover {
            text-decoration: underline;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.8em;
            border: none;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: #c82333;
            transform: none;
            box-shadow: none;
        }

        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
            margin: 0 15px;
            transition: color 0.2s;
        }

        .footer a:hover {
            color: #764ba2;
        }

        .footer p {
            margin-top: 15px;
        }

        /* Collection Panel Styles */
        .collection-panel {
            background: #f0f4ff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }

        .collection-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .collection-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collection-selector label {
            margin: 0;
            font-weight: 600;
            color: #333;
        }

        .collection-selector select {
            min-width: 200px;
            padding: 8px 12px;
        }

        .collection-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.9em;
        }

        .collection-id-display {
            color: #666;
            font-family: monospace;
        }

        .collection-link {
            color: #667eea;
            text-decoration: none;
        }

        .collection-link:hover {
            text-decoration: underline;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .field-note {
            font-weight: normal;
            font-size: 0.85em;
            color: #667eea;
        }

        /* Identifiers Section Styles */
        .identifiers-section {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .identifiers-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.1em;
        }

        .identifiers-list {
            margin-bottom: 15px;
        }

        .identifier-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .identifier-row:last-child {
            margin-bottom: 0;
        }

        .identifier-type-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            margin-right: 10px;
        }

        .identifier-value {
            flex: 1;
        }

        .identifier-value a {
            color: #667eea;
            text-decoration: none;
        }

        .identifier-value a:hover {
            text-decoration: underline;
        }

        .add-identifier-form {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .add-identifier-form select {
            min-width: 150px;
            padding: 8px 12px;
        }

        .add-identifier-form input {
            flex: 1;
            min-width: 150px;
            padding: 8px 12px;
        }

        .no-identifiers {
            color: #666;
            font-style: italic;
            padding: 10px 0;
        }

        /* Vocab Tree Widget Integration */
        #vocab-tree-container {
            flex-shrink: 0;
        }

        #vocab-tree-container .vocab-tree-widget {
            background: #f0f4ff;
            border-color: #667eea;
        }

        #vocab-tree-container .vocab-tree-add-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        #vocab-tree-container .vocab-tree-add-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #5a6fd6 0%, #6a4292 100%);
        }

        @media (max-width: 900px) {
            #vocab-tree-container {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        {% if user.is_authenticated %}
        <div class="user-navbar">
            <span>Welcome, <strong>{{ user.username }}</strong></span>
            <div class="collections-dropdown">
                <button class="collections-btn" onclick="toggleCollectionsMenu()">My Collections</button>
                <div id="collectionsMenu" class="collections-menu">
                    <div class="collections-menu-header">
                        <span>My Collections</span>
                        <a href="{% url 'collections' %}" style="font-size: 0.85em; font-weight: normal;">View All</a>
                    </div>
                    <div id="collectionsMenuList" class="collections-menu-list">
                        <div class="no-collections">Loading...</div>
                    </div>
                    <button class="new-collection-btn" onclick="showNewCollectionModal()">+ New Collection</button>
                </div>
            </div>
            <a href="{% url 'contact:feedback' %}?url={{ request.build_absolute_uri }}" id="feedbackLink">Feedback</a>
            <a href="{% url 'contact:contact' %}">Contact</a>
            <a href="{% url 'accounts:logout' %}">Logout</a>
            <div class="settings-dropdown">
                <button class="settings-btn" onclick="toggleSettingsMenu()" title="Search Settings">&#9776;</button>
                <div id="settingsMenu" class="settings-menu">
                    <div class="settings-menu-header">Search Settings</div>
                    <div class="form-group">
                        <label for="embedding">Embedding Model</label>
                        <select id="embedding" name="embedding" required>
                            <option value="">Loading embeddings...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="k">Number of Results (k)</label>
                        <input type="number" id="k" name="k" value="3" min="1" max="20" required>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="user-navbar">
            <a href="{% url 'contact:feedback' %}?url={{ request.build_absolute_uri }}" id="feedbackLink">Feedback</a>
            <a href="{% url 'contact:contact' %}">Contact</a>
            <a href="{% url 'accounts:login' %}">Login</a>
            <a href="{% url 'accounts:register' %}">Register</a>
            <div class="settings-dropdown">
                <button class="settings-btn" onclick="toggleSettingsMenu()" title="Search Settings">&#9776;</button>
                <div id="settingsMenu" class="settings-menu">
                    <div class="settings-menu-header">Search Settings</div>
                    <div class="form-group">
                        <label for="embedding">Embedding Model</label>
                        <select id="embedding" name="embedding" required>
                            <option value="">Loading embeddings...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="k">Number of Results (k)</label>
                        <input type="number" id="k" name="k" value="3" min="1" max="20" required>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <h1>SKOL Semantic Search</h1>
        <p class="subtitle">Search taxonomic descriptions using semantic similarity</p>
        <p style="margin-bottom: 5px;">Try this:</p>
        <div id="example-code-block" data-text="campanulate pileus, stipe stains blue when cut"></div>

        {% if user.is_authenticated %}
        <!-- Active Collection Panel -->
        <div id="collectionPanel" class="collection-panel">
            <div class="collection-panel-header">
                <div class="collection-selector">
                    <label for="activeCollection">Active Collection:</label>
                    <select id="activeCollection" onchange="onCollectionChange()">
                        <option value="">No collection selected</option>
                    </select>
                    <button type="button" class="btn-small" onclick="showNewCollectionModal()">+ New</button>
                </div>
                <div id="collectionInfo" class="collection-info" style="display: none;">
                    <span class="collection-id-display">ID: <span id="activeCollectionId"></span></span>
                    <a id="collectionDetailLink" href="#" target="_blank" class="collection-link">View Details</a>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="search-form">
            <form id="searchForm">
                {% csrf_token %}
                <div class="form-group">
                    <label for="prompt">Description Text {% if user.is_authenticated %}<span id="descriptionNote" class="field-note" style="display: none;">(linked to collection)</span>{% endif %}</label>
                    <div style="display: flex; gap: 20px; align-items: flex-start;">
                        <textarea id="prompt" name="prompt" placeholder="Enter a taxonomic description to search for similar entries..." required style="flex: 1;"></textarea>
                        <div id="vocab-tree-container"
                             data-vocab-tree-widget
                             data-api-base-url="{{ SCRIPT_NAME }}/api"
                             data-description-target="#prompt">
                        </div>
                    </div>
                </div>

                <button type="submit" id="searchButton">Search</button>
            </form>
        </div>

        {% if user.is_authenticated %}
        <!-- Identifiers Section (visible when collection is active) -->
        <div id="identifiersSection" class="identifiers-section" style="display: none;">
            <h3>External Identifiers</h3>
            <div id="identifiersList" class="identifiers-list"></div>
            <div class="add-identifier-form">
                <select id="newIdentifierType" onchange="onIdentifierTypeChange()">
                    <option value="">Select type...</option>
                </select>
                <input type="hidden" id="newFungariumCode">
                <div id="newFungariumSelectContainer"
                     data-fungarium-select
                     data-api-base-url="{{ SCRIPT_NAME }}/api"
                     data-value-input="#newFungariumCode"
                     data-placeholder="Search fungaria..."
                     style="display: none; min-width: 280px;">
                </div>
                <input type="text" id="newIdentifierValue" placeholder="Identifier value (e.g., 336010515)">
                <button type="button" class="btn-small" onclick="addIdentifier()">Add</button>
            </div>
        </div>
        {% endif %}

        <div id="loading" class="loading" style="display: none;">
            Searching...
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>

        <div id="results" class="results"></div>

        <div class="footer">
            <a href="{% url 'about' %}">About</a>
            <a href="{% url 'sources' %}">Sources</a>
            {% if user.is_authenticated %}
            <a href="{% url 'collections' %}">My Collections</a>
            {% endif %}
            <a href="{% url 'contact:contact' %}">Contact</a>
            <a href="{% url 'contact:feedback' %}">Feedback</a>
            <p>&copy; 2019-2026 SKOL Project Contributors. Licensed under GPLv3.</p>
        </div>
    </div>

    <!-- New Collection Modal -->
    <div id="newCollectionModal" class="modal-overlay">
        <div class="modal">
            <h2>New Collection</h2>
            <form id="newCollectionForm">
                <div class="form-group">
                    <label for="collectionName">Collection Name</label>
                    <input type="text" id="collectionName" name="name" placeholder="My Research Collection" required>
                </div>
                <div class="form-group">
                    <label for="collectionNotes">Notes (optional)</label>
                    <textarea id="collectionNotes" name="notes" placeholder="Notes about this collection..." style="min-height: 60px;"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-cancel-btn" onclick="hideNewCollectionModal()">Cancel</button>
                    <button type="submit">Create Collection</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // Base path for API calls - derived from Django's FORCE_SCRIPT_NAME setting
        const API_BASE = '{{ SCRIPT_NAME }}';
        const IS_AUTHENTICATED = {{ user.is_authenticated|yesno:"true,false" }};

        // Store current search data and active collection
        let currentSearchData = null;
        let userCollections = [];
        let identifierTypes = [];
        let activeCollectionId = null;
        let activeCollectionData = null;

        // CSRF token for POST requests
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Load available embeddings on page load
        async function loadEmbeddings() {
            try {
                const response = await fetch(`${API_BASE}/api/embeddings/`);
                const data = await response.json();

                const select = document.getElementById('embedding');
                select.innerHTML = '';

                if (data.embeddings && data.embeddings.length > 0) {
                    data.embeddings.forEach(embedding => {
                        const option = document.createElement('option');
                        option.value = embedding;
                        option.textContent = embedding;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No embeddings found</option>';
                }
            } catch (error) {
                console.error('Error loading embeddings:', error);
                document.getElementById('embedding').innerHTML = '<option value="">Error loading embeddings</option>';
            }
        }

        // Load user's collections
        async function loadCollections() {
            if (!IS_AUTHENTICATED) return;

            try {
                const response = await fetch(`${API_BASE}/api/collections/`, {
                    credentials: 'same-origin'
                });
                const data = await response.json();
                userCollections = data.collections || [];
                updateCollectionsMenu();
                updateActiveCollectionDropdown();
            } catch (error) {
                console.error('Error loading collections:', error);
            }
        }

        // Load identifier types
        async function loadIdentifierTypes() {
            if (!IS_AUTHENTICATED) return;

            try {
                const response = await fetch(`${API_BASE}/api/identifier-types/`, {
                    credentials: 'same-origin'
                });
                const data = await response.json();
                identifierTypes = data.identifier_types || [];
                updateIdentifierTypeDropdown();
            } catch (error) {
                console.error('Error loading identifier types:', error);
            }
        }

        // Update the active collection dropdown
        function updateActiveCollectionDropdown() {
            const select = document.getElementById('activeCollection');
            if (!select) return;

            const currentValue = select.value;
            select.innerHTML = '<option value="">No collection selected</option>' +
                userCollections.map(c => `<option value="${c.collection_id}">${escapeHtml(c.name)}</option>`).join('');

            // Restore previous selection if still valid
            if (currentValue && userCollections.some(c => c.collection_id == currentValue)) {
                select.value = currentValue;
            }
        }

        // Update identifier type dropdown in add form
        function updateIdentifierTypeDropdown() {
            const select = document.getElementById('newIdentifierType');
            if (!select) return;

            select.innerHTML = '<option value="">Select type...</option>' +
                identifierTypes.map(t => `<option value="${t.code}">${escapeHtml(t.name)}</option>`).join('');
        }

        // Handle identifier type change - show/hide fungarium dropdown
        function onIdentifierTypeChange() {
            const typeSelect = document.getElementById('newIdentifierType');
            const fungariumContainer = document.getElementById('newFungariumSelectContainer');
            const fungariumInput = document.getElementById('newFungariumCode');

            if (typeSelect.value === 'fungarium') {
                fungariumContainer.style.display = 'block';
                // Initialize the React component if not already done
                if (window.initFungariumSelects) {
                    window.initFungariumSelects();
                }
            } else {
                fungariumContainer.style.display = 'none';
                fungariumInput.value = '';
            }
        }

        // Handle collection selection change
        async function onCollectionChange() {
            const select = document.getElementById('activeCollection');
            const collectionId = select.value;

            if (!collectionId) {
                activeCollectionId = null;
                activeCollectionData = null;
                hideCollectionUI();
                return;
            }

            activeCollectionId = collectionId;
            await loadActiveCollection();
        }

        // Load the active collection's full data
        async function loadActiveCollection() {
            if (!activeCollectionId) return;

            try {
                const response = await fetch(`${API_BASE}/api/collections/${activeCollectionId}/`, {
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    throw new Error('Failed to load collection');
                }

                activeCollectionData = await response.json();
                showCollectionUI();
            } catch (error) {
                console.error('Error loading collection:', error);
                showError('Failed to load collection details');
            }
        }

        // Show collection-related UI elements
        // skipPromptUpdate: if true, don't overwrite the prompt field (used after save)
        function showCollectionUI(skipPromptUpdate = false) {
            if (!activeCollectionData) return;

            // Show collection info
            const infoDiv = document.getElementById('collectionInfo');
            if (infoDiv) {
                document.getElementById('activeCollectionId').textContent = activeCollectionData.collection_id;
                document.getElementById('collectionDetailLink').href = `${API_BASE}/collections/${activeCollectionData.collection_id}/`;
                infoDiv.style.display = 'flex';
            }

            // Show description note
            const descNote = document.getElementById('descriptionNote');
            if (descNote) descNote.style.display = 'inline';

            // Load description into prompt field when switching collections
            // Skip this when called after a save operation (to preserve user's edits)
            if (!skipPromptUpdate) {
                document.getElementById('prompt').value = activeCollectionData.description || '';
            }

            // Show identifiers section
            const identifiersSection = document.getElementById('identifiersSection');
            if (identifiersSection) {
                identifiersSection.style.display = 'block';
                updateIdentifiersDisplay();
            }
        }

        // Hide collection-related UI elements
        function hideCollectionUI() {
            const infoDiv = document.getElementById('collectionInfo');
            if (infoDiv) infoDiv.style.display = 'none';

            const descNote = document.getElementById('descriptionNote');
            if (descNote) descNote.style.display = 'none';

            const identifiersSection = document.getElementById('identifiersSection');
            if (identifiersSection) identifiersSection.style.display = 'none';
        }

        // Update the identifiers display
        function updateIdentifiersDisplay() {
            const list = document.getElementById('identifiersList');
            if (!list || !activeCollectionData) return;

            const identifiers = activeCollectionData.external_identifiers || [];

            if (identifiers.length === 0) {
                list.innerHTML = '<div class="no-identifiers">No identifiers added yet</div>';
                return;
            }

            list.innerHTML = identifiers.map(i => {
                // For fungarium identifiers, show the fungarium code and name
                let displayType = i.identifier_type_name;
                if (i.fungarium_code) {
                    displayType = i.fungarium_code;
                    if (i.fungarium_name) {
                        displayType += ` (${i.fungarium_name})`;
                    }
                }

                return `
                    <div class="identifier-row">
                        <div style="display: flex; align-items: center;">
                            <span class="identifier-type-badge">${escapeHtml(displayType)}</span>
                            <span class="identifier-value">
                                ${i.url ? `<a href="${escapeHtml(i.url)}" target="_blank">${escapeHtml(i.value)}</a>` : escapeHtml(i.value)}
                            </span>
                        </div>
                        <button class="delete-btn" onclick="deleteIdentifier(${i.id})">Delete</button>
                    </div>
                `;
            }).join('');
        }

        // Add a new identifier
        async function addIdentifier() {
            if (!activeCollectionId) {
                alert('Please select a collection first');
                return;
            }

            const typeCode = document.getElementById('newIdentifierType').value;
            const fungariumCode = document.getElementById('newFungariumCode').value;
            const value = document.getElementById('newIdentifierValue').value.trim();

            if (!typeCode || !value) {
                alert('Please select a type and enter a value');
                return;
            }

            // For fungarium identifiers, require fungarium code
            if (typeCode === 'fungarium' && !fungariumCode) {
                alert('Please select a fungarium');
                return;
            }

            // Build request body
            const requestBody = {
                identifier_type_code: typeCode,
                value: value
            };

            // Include fungarium_code if this is a fungarium identifier
            if (typeCode === 'fungarium' && fungariumCode) {
                requestBody.fungarium_code = fungariumCode;
            }

            try {
                const response = await fetch(`${API_BASE}/api/collections/${activeCollectionId}/identifiers/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to add identifier');
                }

                // Clear form
                document.getElementById('newIdentifierType').value = '';
                document.getElementById('newFungariumCode').value = '';
                document.getElementById('newFungariumSelectContainer').style.display = 'none';
                document.getElementById('newIdentifierValue').value = '';

                // Reload collection to get updated identifiers
                await loadActiveCollection();
                showSuccess('Identifier added!');

            } catch (error) {
                showError(error.message);
            }
        }

        // Delete an identifier
        async function deleteIdentifier(identifierId) {
            if (!activeCollectionId) return;

            if (!confirm('Delete this identifier?')) return;

            try {
                const response = await fetch(`${API_BASE}/api/collections/${activeCollectionId}/identifiers/${identifierId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete identifier');
                }

                await loadActiveCollection();
                showSuccess('Identifier deleted');

            } catch (error) {
                showError(error.message);
            }
        }

        // Update collections dropdown menu in navbar
        function updateCollectionsMenu() {
            const menuList = document.getElementById('collectionsMenuList');
            if (!menuList) return;

            if (userCollections.length === 0) {
                menuList.innerHTML = '<div class="no-collections">No collections yet. Create one to save your searches!</div>';
                return;
            }

            menuList.innerHTML = userCollections.slice(0, 5).map(c => `
                <a href="${API_BASE}/collections/${c.collection_id}/" class="collection-menu-item" style="display: block; text-decoration: none; color: inherit;">
                    <div class="collection-name">${escapeHtml(c.name)}</div>
                    <div class="collection-meta">${c.search_count || 0} searches, ${c.identifier_count || 0} identifiers</div>
                </a>
            `).join('');

            if (userCollections.length > 5) {
                menuList.innerHTML += `<div class="collection-menu-item" style="text-align: center; color: #666;">
                    <a href="${API_BASE}/collections/">View all ${userCollections.length} collections</a>
                </div>`;
            }
        }

        // Toggle collections menu
        function toggleCollectionsMenu() {
            const menu = document.getElementById('collectionsMenu');
            menu.classList.toggle('show');
            // Close settings menu when opening collections
            document.getElementById('settingsMenu')?.classList.remove('show');
        }

        // Toggle settings menu
        function toggleSettingsMenu() {
            const menu = document.getElementById('settingsMenu');
            menu.classList.toggle('show');
            // Close collections menu when opening settings
            document.getElementById('collectionsMenu')?.classList.remove('show');
        }

        // Close dropdown menus when clicking outside
        document.addEventListener('click', function(event) {
            const collectionsDropdown = document.querySelector('.collections-dropdown');
            if (collectionsDropdown && !collectionsDropdown.contains(event.target)) {
                document.getElementById('collectionsMenu')?.classList.remove('show');
            }
            const settingsDropdown = document.querySelector('.settings-dropdown');
            if (settingsDropdown && !settingsDropdown.contains(event.target)) {
                document.getElementById('settingsMenu')?.classList.remove('show');
            }
        });

        // Show new collection modal
        function showNewCollectionModal() {
            document.getElementById('collectionsMenu')?.classList.remove('show');
            document.getElementById('newCollectionModal').classList.add('show');
            document.getElementById('collectionName').focus();
        }

        // Hide new collection modal
        function hideNewCollectionModal() {
            document.getElementById('newCollectionModal').classList.remove('show');
            document.getElementById('newCollectionForm').reset();
        }

        // Create new collection
        document.getElementById('newCollectionForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('collectionName').value;
            const notes = document.getElementById('collectionNotes').value;
            // Preserve any existing description text - it becomes part of the new collection
            const description = document.getElementById('prompt').value;

            try {
                const response = await fetch(`${API_BASE}/api/collections/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ name, notes, description })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create collection');
                }

                hideNewCollectionModal();
                showSuccess(`Collection "${name}" created successfully!`);

                // Reload collections and select the new one
                await loadCollections();

                // Select the newly created collection
                const select = document.getElementById('activeCollection');
                if (select) {
                    select.value = data.collection_id;
                    await onCollectionChange();
                }

            } catch (error) {
                showError(error.message);
            }
        });

        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Handle form submission
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const prompt = document.getElementById('prompt').value;
            const embedding = document.getElementById('embedding').value;
            const k = parseInt(document.getElementById('k').value);

            // Show loading, hide error and results
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
            document.getElementById('results').innerHTML = '';
            document.getElementById('searchButton').disabled = true;

            try {
                const response = await fetch(`${API_BASE}/api/search/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        prompt: prompt,
                        embedding_name: embedding,
                        k: k
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Search failed');
                }

                displayResults(data);

                // Automatically save search to active collection if one is selected
                if (activeCollectionId && data.results && data.results.length > 0) {
                    await saveSearchToHistory(data);
                }

            } catch (error) {
                document.getElementById('error').textContent = error.message;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchButton').disabled = false;
            }
        });

        // Save search to collection (updates description AND adds to history)
        async function saveSearchToHistory(searchData) {
            if (!activeCollectionId || !searchData) return;

            try {
                // First, update the collection's description
                await fetch(`${API_BASE}/api/collections/${activeCollectionId}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        name: activeCollectionData.name,
                        description: searchData.prompt
                    })
                });

                // Then, add to search history
                const response = await fetch(`${API_BASE}/api/collections/${activeCollectionId}/searches/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        prompt: searchData.prompt,
                        embedding_name: searchData.embedding_name,
                        k: searchData.k,
                        result_references: searchData.results.map(r => ({
                            similarity: r.Similarity,
                            title: r.Title,
                            taxa_id: r.PDFDocId || null
                        }))
                    })
                });

                if (!response.ok) {
                    const data = await response.json();
                    console.error('Failed to save search to history:', data.error);
                    return;
                }

                // Update local collection data (skip overwriting prompt)
                await loadActiveCollection();
                showCollectionUI(true);

            } catch (error) {
                console.error('Error saving search to collection:', error);
            }
        }

        // Display search results
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');

            // Store search data for reference
            currentSearchData = data;

            if (!data.results || data.results.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">No results found</div>';
                return;
            }

            // Show result count and collection status
            let collectionStatus = '';
            if (IS_AUTHENTICATED && activeCollectionId) {
                collectionStatus = `<span style="color: #667eea; font-size: 0.9em;">Saved to collection</span>`;
            }

            resultsDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <span style="color: #666;">Found ${data.results.length} results</span>
                    ${collectionStatus}
                </div>
            `;

            data.results.forEach((result, index) => {
                const card = document.createElement('div');
                card.className = 'result-card';

                const similarity = (result.Similarity * 100).toFixed(1);

                // Build PDF viewer URL if source metadata is available
                let pdfLink = '';
                let pageFragment = '';

                // Determine page label/number for direct linking: prefer pdf_label, then pdf_page
                if (result.PDFLabel) {
                    pageFragment = `#page=${encodeURIComponent(result.PDFLabel)}`;
                } else if (result.PDFPage) {
                    pageFragment = `#page=${result.PDFPage}`;
                }

                if (result.PDFDbName && result.PDFDocId) {
                    let pdfUrl = `${API_BASE}/pdf/?db=${encodeURIComponent(result.PDFDbName)}&doc_id=${encodeURIComponent(result.PDFDocId)}`;
                    if (result.PDFPage) {
                        pdfUrl += `&page=${result.PDFPage}`;
                    }
                    pdfUrl += pageFragment;
                    pdfLink = `<a href="${pdfUrl}" class="view-pdf-btn" target="_blank">View PDF</a>`;
                }

                card.innerHTML = `
                    <div class="result-header">
                        <div class="result-title">${escapeHtml(result.Title || 'Untitled')}</div>
                        <div class="similarity-badge">${similarity}%</div>
                    </div>
                    <div class="result-meta">
                        ${result.Feed ? `<div class="meta-item"><span class="meta-label">Feed:</span>${escapeHtml(typeof result.Feed === 'object' ? JSON.stringify(result.Feed) : result.Feed)}</div>` : ''}
                        ${result.PDFPage ? `<div class="meta-item"><span class="meta-label">PDF Page:</span>${result.PDFPage}</div>` : ''}
                        ${result.LineNumber ? `<div class="meta-item"><span class="meta-label">Line:</span>${result.LineNumber}</div>` : ''}
                    </div>
                    ${result.Description ? `<div class="result-description">${escapeHtml(result.Description).substring(0, 500)}${result.Description.length > 500 ? '...' : ''}</div>` : ''}
                    <div class="result-actions">
                        ${pdfLink}
                        ${result.URL ? `<a href="${escapeHtml(result.URL)}${pageFragment}" target="_blank" class="view-pdf-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">View Source</a>` : ''}
                        <button class="toggle-json" onclick="toggleJson(${index})">Show Full JSON</button>
                    </div>
                    <div id="json-${index}" class="result-json" style="display: none;">
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;

                resultsDiv.appendChild(card);
            });
        }

        // Toggle JSON display
        function toggleJson(index) {
            const jsonDiv = document.getElementById(`json-${index}`);
            const button = event.target;

            if (jsonDiv.style.display === 'none') {
                jsonDiv.style.display = 'block';
                button.textContent = 'Hide Full JSON';
            } else {
                jsonDiv.style.display = 'none';
                button.textContent = 'Show Full JSON';
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Load data when page loads
        loadEmbeddings();
        if (IS_AUTHENTICATED) {
            loadCollections();
            loadIdentifierTypes();
        }
    </script>

    <!-- Code Block Component -->
    <script src="{% static 'js/code-block.bundle.js' %}"></script>

    <!-- Vocabulary Tree Widget -->
    <script src="{% static 'js/vocab-tree.bundle.js' %}"></script>

    <!-- Fungarium Select Widget -->
    <script src="{% static 'js/fungarium-select.bundle.js' %}"></script>
</body>
</html>
