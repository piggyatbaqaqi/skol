{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKOL Semantic Search</title>
    <link rel="icon" type="image/png" href="{% static 'favicon.png' %}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .search-form {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        textarea, select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        textarea:focus, select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .inline-group {
            display: flex;
            gap: 20px;
        }

        .inline-group .form-group {
            flex: 1;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 500;
        }

        .error {
            background: #fee;
            border: 2px solid #fcc;
            border-radius: 6px;
            padding: 15px;
            color: #c33;
            margin-bottom: 20px;
        }

        .success {
            background: #efe;
            border: 2px solid #cfc;
            border-radius: 6px;
            padding: 15px;
            color: #393;
            margin-bottom: 20px;
        }

        .results {
            margin-top: 30px;
        }

        .result-card {
            background: #f9f9f9;
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .result-title {
            color: #333;
            font-size: 1.3em;
            font-weight: 600;
            flex: 1;
        }

        .similarity-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 15px;
        }

        .result-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #666;
        }

        .meta-item {
            display: flex;
            align-items: center;
        }

        .meta-label {
            font-weight: 600;
            margin-right: 5px;
        }

        .result-description {
            color: #444;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .result-json {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }

        .toggle-json {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-top: 10px;
        }

        .toggle-json:hover {
            background: #e8e8e8;
            transform: none;
            box-shadow: none;
        }

        .view-pdf-btn {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-top: 10px;
            margin-right: 10px;
            text-decoration: none;
            display: inline-block;
        }

        .view-pdf-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
            transform: none;
            box-shadow: none;
            color: white;
        }

        .save-collection-btn {
            background: linear-gradient(135deg, #f0ad4e 0%, #ec971f 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
        }

        .save-collection-btn:hover {
            background: linear-gradient(135deg, #ec971f 0%, #d58512 100%);
            transform: none;
            box-shadow: none;
        }

        .result-actions {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1em;
        }

        .user-navbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }

        .user-navbar a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.2s;
        }

        .user-navbar a:hover {
            color: #764ba2;
        }

        /* Collections dropdown styles */
        .collections-dropdown {
            position: relative;
            display: inline-block;
        }

        .collections-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
            border: none;
        }

        .collections-btn:hover {
            transform: none;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .collections-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            min-width: 250px;
            max-width: 350px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            margin-top: 5px;
        }

        .collections-menu.show {
            display: block;
        }

        .collections-menu-header {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collections-menu-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .collection-menu-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .collection-menu-item:hover {
            background: #f5f5f5;
        }

        .collection-menu-item:last-child {
            border-bottom: none;
        }

        .collection-menu-item .collection-name {
            font-weight: 500;
            color: #333;
        }

        .collection-menu-item .collection-meta {
            font-size: 0.85em;
            color: #666;
            margin-top: 3px;
        }

        .new-collection-btn {
            display: block;
            width: 100%;
            padding: 12px 15px;
            background: #f9f9f9;
            border: none;
            border-top: 1px solid #e0e0e0;
            color: #667eea;
            font-weight: 500;
            cursor: pointer;
            text-align: left;
            border-radius: 0 0 8px 8px;
        }

        .new-collection-btn:hover {
            background: #f0f0f0;
            transform: none;
            box-shadow: none;
        }

        .no-collections {
            padding: 20px 15px;
            color: #666;
            text-align: center;
            font-size: 0.9em;
        }

        /* Settings hamburger menu */
        .settings-dropdown {
            position: relative;
            display: inline-block;
        }

        .settings-btn {
            background: transparent;
            color: #667eea;
            padding: 8px;
            border-radius: 4px;
            font-size: 1.4em;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            line-height: 1;
            transition: background 0.2s, border-color 0.2s;
        }

        .settings-btn:hover {
            background: #f5f5f5;
            border-color: #667eea;
            transform: none;
            box-shadow: none;
        }

        .settings-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            min-width: 280px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            margin-top: 5px;
            padding: 15px;
        }

        .settings-menu.show {
            display: block;
        }

        .settings-menu-header {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .settings-menu .form-group {
            margin-bottom: 15px;
        }

        .settings-menu .form-group:last-child {
            margin-bottom: 0;
        }

        .settings-menu label {
            font-size: 0.9em;
            color: #555;
        }

        .settings-menu select,
        .settings-menu input {
            font-size: 0.9em;
            padding: 8px 10px;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-cancel-btn {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }

        .modal-cancel-btn:hover {
            background: #e8e8e8;
            transform: none;
            box-shadow: none;
        }

        /* Identifier form styles */
        .identifier-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .identifier-list {
            margin-bottom: 15px;
        }

        .identifier-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .identifier-link {
            color: #667eea;
            text-decoration: none;
        }

        .identifier-link:hover {
            text-decoration: underline;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.8em;
            border: none;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: #c82333;
            transform: none;
            box-shadow: none;
        }

        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
            margin: 0 15px;
            transition: color 0.2s;
        }

        .footer a:hover {
            color: #764ba2;
        }

        .footer p {
            margin-top: 15px;
        }

        /* Collection Panel Styles */
        .collection-panel {
            background: #f0f4ff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }

        .collection-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .collection-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collection-selector label {
            margin: 0;
            font-weight: 600;
            color: #333;
        }

        .collection-selector select {
            min-width: 200px;
            padding: 8px 12px;
        }

        .collection-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.9em;
        }

        .collection-id-display {
            color: #666;
            font-family: monospace;
        }

        .collection-link {
            color: #667eea;
            text-decoration: none;
        }

        .collection-link:hover {
            text-decoration: underline;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .dismiss-btn {
            background: transparent;
            border: 1px solid #666;
            color: #666;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
        }

        .dismiss-btn:hover {
            background: #f0f0f0;
            transform: none;
            box-shadow: none;
        }

        .guest-notice {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .field-note {
            font-weight: normal;
            font-size: 0.85em;
            color: #667eea;
        }

        .flag-link {
            font-size: 0.8em;
            font-weight: normal;
            color: #888;
            text-decoration: none;
            cursor: pointer;
        }
        .flag-link:hover { color: #e67e22; }
        .flag-link.flag-active {
            color: #e67e22;
            cursor: default;
        }
        .flag-badge {
            font-size: 0.75em;
            font-weight: 500;
            color: #e67e22;
            margin-left: 4px;
        }
        .hidden-notice {
            font-size: 0.8em;
            font-weight: 500;
            color: #e74c3c;
            margin-left: 12px;
        }

        /* Nomenclature Field Styles */
        .nomenclature-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #d0d8f0;
        }

        .nomenclature-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nomenclature-row label {
            margin: 0;
            font-weight: 600;
            color: #333;
            white-space: nowrap;
        }

        .nomenclature-row input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }

        .nomenclature-row input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .nomenclature-save-indicator {
            font-size: 0.85em;
            color: #28a745;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .nomenclature-save-indicator.show {
            opacity: 1;
        }

        /* Copy to Nomenclature Button */
        .copy-nomenclature-btn {
            background: transparent;
            border: 1px solid #667eea;
            color: #667eea;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            margin-left: 8px;
        }

        .copy-nomenclature-btn:hover {
            background: #667eea;
            color: white;
            transform: none;
            box-shadow: none;
        }

        .copy-nomenclature-btn.copied {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }

        /* Identifiers Section Styles */
        .identifiers-section {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .identifiers-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.1em;
        }

        .identifiers-list {
            margin-bottom: 15px;
        }

        .identifier-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .identifier-row:last-child {
            margin-bottom: 0;
        }

        .identifier-type-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            margin-right: 10px;
        }

        .identifier-value {
            flex: 1;
        }

        .identifier-value a {
            color: #667eea;
            text-decoration: none;
        }

        .identifier-value a:hover {
            text-decoration: underline;
        }

        .add-identifier-form {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .add-identifier-form select {
            min-width: 150px;
            padding: 8px 12px;
        }

        .add-identifier-form input {
            flex: 1;
            min-width: 150px;
            padding: 8px 12px;
        }

        .no-identifiers {
            color: #666;
            font-style: italic;
            padding: 10px 0;
        }

        /* Feature Selection Widget Integration */
        #feature-selection-container {
            flex-shrink: 0;
        }

        #feature-selection-container .vocab-tree-add-btn,
        #feature-selection-container .feature-add-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        #feature-selection-container .vocab-tree-add-btn:hover:not(:disabled),
        #feature-selection-container .feature-add-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #5a6fd6 0%, #6a4292 100%);
        }

        /* Pagination bar */
        .pagination-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            margin: 8px 0;
            position: sticky;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
            border-top: 1px solid #e0e0e0;
            z-index: 10;
        }

        .pagination-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            min-width: 80px;
            min-height: 44px;
            transition: opacity 0.2s, transform 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-info {
            color: #555;
            font-weight: 500;
            min-width: 120px;
            text-align: center;
        }

        /* Mobile: stack textarea and vocab widget vertically */
        @media (max-width: 900px) {
            .form-group > div[style*="display: flex"] {
                flex-direction: column !important;
            }

            #feature-selection-container {
                width: 100%;
                margin-top: 15px;
            }

            #feature-selection-container .vocab-tree-widget,
            #feature-selection-container .feature-selection-widget {
                max-width: 100%;
            }
        }

        /* Mobile hamburger menu */
        .mobile-menu-btn {
            display: none;
            background: transparent;
            border: 1px solid #667eea;
            color: #667eea;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 1.4em;
            cursor: pointer;
            line-height: 1;
        }

        .mobile-menu-btn:hover {
            background: #f0f4ff;
            transform: none;
            box-shadow: none;
        }

        /* Slide-in menu overlay */
        .mobile-menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
        }

        .mobile-menu-overlay.show {
            display: block;
        }

        /* Slide-in menu panel */
        .mobile-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: white;
            z-index: 3001;
            transition: left 0.3s ease;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
        }

        .mobile-menu.show {
            left: 0;
        }

        .mobile-menu-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mobile-menu-header .user-info {
            font-weight: 600;
        }

        .mobile-menu-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .mobile-menu-close:hover {
            transform: none;
            box-shadow: none;
        }

        .mobile-menu-items {
            padding: 10px 0;
        }

        .mobile-menu-items a,
        .mobile-menu-items button {
            display: block;
            width: 100%;
            padding: 15px 20px;
            color: #333;
            text-decoration: none;
            border: none;
            background: transparent;
            text-align: left;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.2s;
        }

        .mobile-menu-items a:hover,
        .mobile-menu-items button:hover {
            background: #f5f5f5;
            transform: none;
            box-shadow: none;
        }

        .mobile-menu-items .menu-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 10px 20px;
        }

        .mobile-menu-items .menu-section-title {
            padding: 10px 20px 5px;
            font-size: 0.8em;
            font-weight: 600;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Mobile: hide desktop navbar items, show hamburger */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .user-navbar {
                justify-content: space-between;
            }

            .user-navbar > *:not(.mobile-menu-btn) {
                display: none;
            }

            .user-navbar .settings-dropdown {
                display: block;
            }

            .pagination-btn {
                padding: 14px 20px;
                min-height: 48px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Mobile slide-in menu -->
        <div id="mobileMenuOverlay" class="mobile-menu-overlay" onclick="closeMobileMenu()"></div>
        <div id="mobileMenu" class="mobile-menu">
            <div class="mobile-menu-header">
                {% if user.is_authenticated %}
                <span class="user-info">{{ user.username }}</span>
                {% else %}
                <span class="user-info">Menu</span>
                {% endif %}
                <button class="mobile-menu-close" onclick="closeMobileMenu()">&times;</button>
            </div>
            <div class="mobile-menu-items">
                {% if user.is_authenticated %}
                <div class="menu-section-title">Account</div>
                <a href="{% url 'accounts:account_settings' %}">Account Settings</a>
                <a href="{% url 'accounts:logout' %}">Logout</a>
                <div class="menu-divider"></div>
                <div class="menu-section-title">Collections</div>
                <a href="{% url 'collections' %}">My Collections</a>
                <button onclick="showNewCollectionModal(); closeMobileMenu();">+ New Collection</button>
                <div class="menu-divider"></div>
                {% else %}
                <div class="menu-section-title">Account</div>
                <a href="{% url 'accounts:login' %}?next={{ request.path }}" onclick="saveGuestDescriptionBeforeNav()">Login</a>
                <a href="{% url 'accounts:register' %}?next={{ request.path }}" onclick="saveGuestDescriptionBeforeNav()">Register</a>
                <div class="menu-divider"></div>
                {% endif %}
                <div class="menu-section-title">Help</div>
                <a href="{% url 'help' %}">Help</a>
                <a href="{% url 'contact:feedback' %}?url={{ request.build_absolute_uri }}">Feedback</a>
                <a href="{% url 'contact:contact' %}">Contact</a>
                <a href="{% url 'about' %}">About</a>
                <a href="{% url 'sources' %}">Sources</a>
            </div>
        </div>

        {% if user.is_authenticated %}
        <div class="user-navbar">
            <button class="mobile-menu-btn" onclick="openMobileMenu()" title="Menu">&#9776;</button>
            <span>Welcome, <strong>{{ user.username }}</strong></span>
            <div class="collections-dropdown">
                <button class="collections-btn" onclick="toggleCollectionsMenu()">My Collections</button>
                <div id="collectionsMenu" class="collections-menu">
                    <div class="collections-menu-header">
                        <span>My Collections</span>
                        <a href="{% url 'collections' %}" style="font-size: 0.85em; font-weight: normal;">View All</a>
                    </div>
                    <div id="collectionsMenuList" class="collections-menu-list">
                        <div class="no-collections">Loading...</div>
                    </div>
                    <button class="new-collection-btn" onclick="showNewCollectionModal()">+ New Collection</button>
                </div>
            </div>
            <a href="{% url 'help' %}">Help</a>
            <a href="{% url 'contact:feedback' %}?url={{ request.build_absolute_uri }}" id="feedbackLink">Feedback</a>
            <a href="{% url 'contact:contact' %}">Contact</a>
            <a href="{% url 'accounts:account_settings' %}">Account</a>
            <a href="{% url 'accounts:logout' %}">Logout</a>
            <div class="settings-dropdown">
                <button class="settings-btn" onclick="toggleSettingsMenu()" title="Search Settings">&#9881;</button>
                <div id="settingsMenu" class="settings-menu">
                    <div class="settings-menu-header">Search Settings</div>
                    <div class="form-group">
                        <label for="embedding">Embedding Model</label>
                        <select id="embedding" name="embedding" required>
                            <option value="">Loading embeddings...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="k">Total Results (k)</label>
                        <input type="number" id="k" name="k" value="20" min="1" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="resultsPerPage">Results Per Page</label>
                        <input type="number" id="resultsPerPage" value="10" min="5" max="50" title="Number of results to show per page" onchange="saveResultsPerPage(this.value)">
                    </div>
                    <div class="form-group">
                        <label for="nomenclatureLimit">Nomenclature Results</label>
                        <input type="number" id="nomenclatureLimit" value="20" min="1" max="200" title="Maximum results for nomenclature pattern search">
                    </div>
                    <div class="settings-menu-header" style="margin-top: 8px;">Feature Settings</div>
                    <div class="form-group">
                        <label for="featureTaxaCount">Taxa for Features</label>
                        <input type="number" id="featureTaxaCount" value="6" min="2" max="50" title="Number of taxa to retrieve for building feature lists">
                    </div>
                    <div class="form-group">
                        <label for="featureTopN">Feature Count</label>
                        <input type="number" id="featureTopN" value="30" min="5" max="100" title="Number of top features to return from the classifier">
                    </div>
                    <div class="form-group">
                        <label for="featureMaxDepth">Tree Depth</label>
                        <input type="number" id="featureMaxDepth" value="10" min="1" max="50" title="Maximum depth for the decision tree">
                    </div>
                    <div class="form-group">
                        <label for="featureMinDf">Min Doc Frequency</label>
                        <input type="number" id="featureMinDf" value="1" min="1" max="10" title="Minimum number of documents a term must appear in">
                    </div>
                    <div class="form-group">
                        <label for="featureMaxDf">Max Doc Frequency</label>
                        <input type="number" id="featureMaxDf" value="1.0" min="0.1" max="1.0" step="0.05" title="Maximum fraction of documents a term can appear in (1.0 = no limit)">
                    </div>
                    <div class="settings-menu-header" style="margin-top: 8px;">Email Preferences</div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="receiveAdminSummary" style="width: auto;" onchange="saveAdminSummaryPref()">
                        <label for="receiveAdminSummary" style="margin-bottom: 0; cursor: pointer;">Receive daily admin summary</label>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="user-navbar">
            <button class="mobile-menu-btn" onclick="openMobileMenu()" title="Menu">&#9776;</button>
            <a href="{% url 'help' %}">Help</a>
            <a href="{% url 'contact:feedback' %}?url={{ request.build_absolute_uri }}" id="feedbackLink">Feedback</a>
            <a href="{% url 'contact:contact' %}">Contact</a>
            <a href="{% url 'accounts:login' %}?next={{ request.path }}" onclick="saveGuestDescriptionBeforeNav()">Login</a>
            <a href="{% url 'accounts:register' %}?next={{ request.path }}" onclick="saveGuestDescriptionBeforeNav()">Register</a>
            <div class="settings-dropdown">
                <button class="settings-btn" onclick="toggleSettingsMenu()" title="Search Settings">&#9881;</button>
                <div id="settingsMenu" class="settings-menu">
                    <div class="settings-menu-header">Search Settings</div>
                    <div class="form-group">
                        <label for="embedding">Embedding Model</label>
                        <select id="embedding" name="embedding" required>
                            <option value="">Loading embeddings...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="k">Total Results (k)</label>
                        <input type="number" id="k" name="k" value="20" min="1" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="resultsPerPage">Results Per Page</label>
                        <input type="number" id="resultsPerPage" value="10" min="5" max="50" title="Number of results to show per page" onchange="saveResultsPerPage(this.value)">
                    </div>
                    <div class="form-group">
                        <label for="nomenclatureLimit">Nomenclature Results</label>
                        <input type="number" id="nomenclatureLimit" value="20" min="1" max="200" title="Maximum results for nomenclature pattern search">
                    </div>
                    <div class="settings-menu-header" style="margin-top: 8px;">Feature Settings</div>
                    <div class="form-group">
                        <label for="featureTaxaCount">Taxa for Features</label>
                        <input type="number" id="featureTaxaCount" value="6" min="2" max="50" title="Number of taxa to retrieve for building feature lists">
                    </div>
                    <div class="form-group">
                        <label for="featureTopN">Feature Count</label>
                        <input type="number" id="featureTopN" value="30" min="5" max="100" title="Number of top features to return from the classifier">
                    </div>
                    <div class="form-group">
                        <label for="featureMaxDepth">Tree Depth</label>
                        <input type="number" id="featureMaxDepth" value="10" min="1" max="50" title="Maximum depth for the decision tree">
                    </div>
                    <div class="form-group">
                        <label for="featureMinDf">Min Doc Frequency</label>
                        <input type="number" id="featureMinDf" value="1" min="1" max="10" title="Minimum number of documents a term must appear in">
                    </div>
                    <div class="form-group">
                        <label for="featureMaxDf">Max Doc Frequency</label>
                        <input type="number" id="featureMaxDf" value="1.0" min="0.1" max="1.0" step="0.05" title="Maximum fraction of documents a term can appear in (1.0 = no limit)">
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <h1>SKOL Semantic Search</h1>
        <p class="subtitle">Search taxonomic descriptions using semantic similarity</p>
        <p style="margin-bottom: 5px;">Try this:</p>
        <div id="example-code-block" data-text="campanulate pileus, stipe stains blue when cut"></div>

        {% if user.is_authenticated %}
        <!-- Active Collection Panel -->
        <div id="collectionPanel" class="collection-panel">
            <div class="collection-panel-header">
                <div class="collection-selector">
                    <label>Active Collection:</label>
                    <input type="hidden" id="activeCollection">
                    <div id="activeCollectionSelectContainer"
                         data-collection-select
                         data-api-base-url="{{ SCRIPT_NAME }}/api"
                         data-value-input="#activeCollection"
                         data-on-change="onCollectionChange"
                         data-placeholder="Select collection..."
                         style="min-width: 220px;">
                    </div>
                    <button type="button" class="btn-small" onclick="showNewCollectionModal()">+ New</button>
                </div>
                <div id="collectionInfo" class="collection-info" style="display: none;">
                    <span class="collection-id-display">ID: <span id="activeCollectionId"></span></span>
                    <a id="collectionDetailLink" href="#" target="_blank" class="collection-link">View Details</a>
                </div>
            </div>
            <!-- Nomenclature field (visible when collection is active) -->
            <div id="nomenclatureSection" class="nomenclature-section" style="display: none;">
                <div class="nomenclature-row">
                    <label for="nomenclatureInput">Nomenclature:</label>
                    <input type="text" id="nomenclatureInput" placeholder="Best guess taxon name (e.g., Amanita muscaria)" />
                    <span id="nomenclatureSaveIndicator" class="nomenclature-save-indicator">Saved</span>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="search-form">
            <form id="searchForm">
                {% csrf_token %}
                <div class="form-group">
                    <label for="prompt">Description Text {% if user.is_authenticated %}<span id="descriptionNote" class="field-note" style="display: none;">(linked to collection)</span><span id="collectionFlagArea" style="display: none; margin-left: 12px;"><a href="#" id="collectionFlagLink" class="flag-link" onclick="flagCollection(); return false;">Flag</a><span id="collectionFlagBadge" class="flag-badge" style="display: none;"></span><a href="#" id="collectionUnflagLink" class="flag-link" style="display: none;" onclick="unflagCollection(); return false;">Unflag</a><a href="#" id="collectionHideLink" class="flag-link" style="display: none;" onclick="hideCollectionAction(); return false;">Hide</a><a href="#" id="collectionUnhideLink" class="flag-link" style="display: none;" onclick="unhideCollectionAction(); return false;">Unhide</a></span><span id="collectionHiddenNotice" class="hidden-notice" style="display: none;">Hidden by admin</span>{% endif %}</label>
                    <div style="display: flex; gap: 20px; align-items: flex-start;">
                        <textarea id="prompt" name="prompt" placeholder="Enter a taxonomic description to search for similar entries..." required style="flex: 1;"></textarea>
                        <div id="feature-selection-container"
                             data-feature-selection-widget
                             data-api-base-url="{{ SCRIPT_NAME }}/api"
                             data-description-target="#prompt">
                        </div>
                    </div>
                </div>

                <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                    <button type="submit" id="searchButton">Search</button>
                    <span style="display: inline-flex; align-items: center; gap: 6px;">
                        <input type="text" id="nomenclaturePattern" placeholder="Nomenclature regex..."
                               style="width: 200px; padding: 12px; font-size: 14px;"
                               title="Search by nomenclature pattern (regex supported)">
                        <button type="button" id="nomenclatureSearchButton" onclick="nomenclatureSearch()">List Names</button>
                    </span>
                </div>
            </form>
        </div>

        {% if user.is_authenticated %}
        <!-- Discussion Widget (visible when collection is active) -->
        <div id="discussionSection" style="display: none;">
            <div id="discussion-container"
                 data-discussion-widget
                 data-api-base-url="{{ SCRIPT_NAME }}/api"
                 data-collection-id="">
            </div>
        </div>

        <!-- Identifiers Section (visible when collection is active) -->
        <div id="identifiersSection" class="identifiers-section" style="display: none;">
            <h3>External Identifiers</h3>
            <div id="identifiersList" class="identifiers-list"></div>
            <div class="add-identifier-form">
                <input type="hidden" id="newIdentifierType">
                <div id="newIdentifierTypeSelectContainer"
                     data-identifier-type-select
                     data-api-base-url="{{ SCRIPT_NAME }}/api"
                     data-value-input="#newIdentifierType"
                     data-on-change="onIdentifierTypeChange"
                     data-placeholder="Select type..."
                     style="min-width: 180px;">
                </div>
                <input type="hidden" id="newFungariumCode">
                <div id="newFungariumSelectContainer"
                     data-fungarium-select
                     data-api-base-url="{{ SCRIPT_NAME }}/api"
                     data-value-input="#newFungariumCode"
                     data-placeholder="Search fungaria..."
                     style="display: none; min-width: 280px;">
                </div>
                <input type="text" id="newIdentifierValue" placeholder="Identifier value (e.g., 336010515)">
                <button type="button" class="btn-small" onclick="addIdentifier()">Add</button>
            </div>
        </div>
        {% endif %}

        <div id="loading" class="loading" style="display: none;">
            Searching...
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>

        <div id="results" class="results"></div>

        <div class="footer">
            <a href="{% url 'about' %}">About</a>
            <a href="{% url 'sources' %}">Sources</a>
            {% if user.is_authenticated %}
            <a href="{% url 'collections' %}">My Collections</a>
            {% endif %}
            <a href="{% url 'contact:contact' %}">Contact</a>
            <a href="{% url 'contact:feedback' %}">Feedback</a>
            <p>&copy; 2019-2026 SKOL Project Contributors. Licensed under GPLv3.</p>
        </div>
    </div>

    <!-- New Collection Modal -->
    <div id="newCollectionModal" class="modal-overlay">
        <div class="modal">
            <h2>New Collection</h2>
            <form id="newCollectionForm">
                <div class="form-group">
                    <label for="collectionName">Collection Name</label>
                    <input type="text" id="collectionName" name="name" placeholder="My Research Collection" required>
                </div>
                <div class="form-group">
                    <label for="collectionNomenclature">Taxon Name (Best Guess)</label>
                    <input type="text" id="collectionNomenclature" name="nomenclature" placeholder="e.g., Russula emetica">
                    <small style="color: #666; font-size: 0.85em;">Your best guess for the taxon name. Used in search results.</small>
                </div>
                <div class="form-group">
                    <label for="collectionNotes">Notes (optional)</label>
                    <textarea id="collectionNotes" name="notes" placeholder="Notes about this collection..." style="min-height: 60px;"></textarea>
                </div>
                <div class="form-group">
                    <label for="collectionEmbargo">Embargo Until (optional)</label>
                    <input type="date" id="collectionEmbargo" name="embargo_until">
                    <small style="color: #666; font-size: 0.85em;">Collection is private until this date. Leave empty for public.</small>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-cancel-btn" onclick="hideNewCollectionModal()">Cancel</button>
                    <button type="submit">Create Collection</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Guest Collection must load before main script (which uses it for migration) -->
    <script src="{% static 'js/guest-collection.js' %}"></script>

    <script>
        // Base path for API calls - derived from Django's FORCE_SCRIPT_NAME setting
        const API_BASE = '{{ SCRIPT_NAME }}';
        const IS_AUTHENTICATED = {{ user.is_authenticated|yesno:"true,false" }};
        const IS_ADMIN = {{ user.is_staff|yesno:"true,false" }};
        const CURRENT_USER_ID = {{ user.id|default:"null" }};
        const CURRENT_USERNAME = '{{ user.username|default:""|escapejs }}';

        // Store current search data, active collection, and pagination state
        let currentSearchData = null;
        let currentPage = 1;
        let resultsPerPage = 10;
        let activeCollectionId = null;
        let activeCollectionData = null;

        // CSRF token for POST requests
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Load available embeddings on page load
        async function loadEmbeddings() {
            const select = document.getElementById('embedding');

            try {
                const response = await fetch(`${API_BASE}/api/embeddings/`);
                const data = await response.json();

                select.innerHTML = '';

                if (data.embeddings && data.embeddings.length > 0) {
                    data.embeddings.forEach(embedding => {
                        const option = document.createElement('option');
                        option.value = embedding;
                        option.textContent = embedding;
                        select.appendChild(option);
                    });
                } else {
                    // No embeddings found - trigger build
                    select.innerHTML = '<option value="">Building embeddings...</option>';
                    console.log('No embeddings found, triggering build...');
                    await triggerEmbeddingBuild();
                }
            } catch (error) {
                console.error('Error loading embeddings:', error);
                select.innerHTML = '<option value="">Error loading embeddings</option>';
            }
        }

        // Trigger embedding build if none exist
        async function triggerEmbeddingBuild() {
            const select = document.getElementById('embedding');

            try {
                const response = await fetch(`${API_BASE}/api/embeddings/build/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (data.status === 'complete' || data.status === 'exists') {
                    console.log('Embedding build complete:', data.message);
                    // Reload embeddings list
                    const listResponse = await fetch(`${API_BASE}/api/embeddings/`);
                    const listData = await listResponse.json();

                    select.innerHTML = '';
                    if (listData.embeddings && listData.embeddings.length > 0) {
                        listData.embeddings.forEach(embedding => {
                            const option = document.createElement('option');
                            option.value = embedding;
                            option.textContent = embedding;
                            select.appendChild(option);
                        });
                    } else {
                        select.innerHTML = '<option value="">No embeddings available</option>';
                    }
                } else {
                    console.error('Embedding build failed:', data.message);
                    select.innerHTML = `<option value="">Build failed: ${data.message}</option>`;
                }
            } catch (error) {
                console.error('Error triggering embedding build:', error);
                select.innerHTML = '<option value="">Build error - check server logs</option>';
            }
        }

        // Handle identifier type change - show/hide fungarium dropdown
        // Called by the React IdentifierTypeSelect component
        function onIdentifierTypeChange(typeCode) {
            const fungariumContainer = document.getElementById('newFungariumSelectContainer');
            const fungariumInput = document.getElementById('newFungariumCode');

            if (typeCode === 'fungarium') {
                fungariumContainer.style.display = 'block';
                // Initialize the React component if not already done
                if (window.initFungariumSelects) {
                    window.initFungariumSelects();
                }
            } else {
                fungariumContainer.style.display = 'none';
                fungariumInput.value = '';
            }
        }

        // Handle collection selection change
        // Called by the React CollectionSelect component
        async function onCollectionChange(collectionId, updateUrl = true) {
            if (!collectionId) {
                activeCollectionId = null;
                activeCollectionData = null;
                hideCollectionUI();
                // Remove collection from URL
                if (updateUrl) {
                    const url = new URL(window.location);
                    url.searchParams.delete('collection');
                    window.history.replaceState({}, '', url);
                }
                return;
            }

            activeCollectionId = collectionId;
            await loadActiveCollection();

            // Update URL with collection ID (so refresh/share works)
            if (updateUrl) {
                const url = new URL(window.location);
                url.searchParams.set('collection', collectionId);
                window.history.replaceState({}, '', url);
            }
        }

        // Load the active collection's full data
        async function loadActiveCollection() {
            if (!activeCollectionId) return;

            try {
                const response = await fetch(`${API_BASE}/api/collections/${activeCollectionId}/`, {
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    throw new Error('Failed to load collection');
                }

                activeCollectionData = await response.json();
                showCollectionUI();
            } catch (error) {
                console.error('Error loading collection:', error);
                showError('Failed to load collection details');
            }
        }

        // Show collection-related UI elements
        // skipPromptUpdate: if true, don't overwrite the prompt field (used after save)
        function showCollectionUI(skipPromptUpdate = false) {
            if (!activeCollectionData) return;

            // Show collection info
            const infoDiv = document.getElementById('collectionInfo');
            if (infoDiv) {
                document.getElementById('activeCollectionId').textContent = activeCollectionData.collection_id;
                document.getElementById('collectionDetailLink').href = `${API_BASE}/collections/${activeCollectionData.collection_id}/`;
                infoDiv.style.display = 'flex';
            }

            // Show description note
            const descNote = document.getElementById('descriptionNote');
            if (descNote) descNote.style.display = 'inline';

            // Load description into prompt field when switching collections
            // Skip this when called after a save operation (to preserve user's edits)
            if (!skipPromptUpdate) {
                document.getElementById('prompt').value = activeCollectionData.description || '';
            }

            // Show and load nomenclature
            const nomenclatureSection = document.getElementById('nomenclatureSection');
            const nomenclatureInput = document.getElementById('nomenclatureInput');
            if (nomenclatureSection && nomenclatureInput) {
                nomenclatureSection.style.display = 'block';
                // Load nomenclature, defaulting to "Unknown" if empty
                if (!skipPromptUpdate) {
                    nomenclatureInput.value = activeCollectionData.nomenclature || 'Unknown';
                }
            }

            // Show identifiers section
            const identifiersSection = document.getElementById('identifiersSection');
            if (identifiersSection) {
                identifiersSection.style.display = 'block';
                updateIdentifiersDisplay();
            }

            // Show discussion widget
            const discussionSection = document.getElementById('discussionSection');
            if (discussionSection) {
                discussionSection.style.display = 'block';
                const container = document.getElementById('discussion-container');
                if (container) {
                    container.dataset.collectionId = activeCollectionData.collection_id;
                }
            }

            // Display most recent search results if available (and not skipping prompt update)
            if (!skipPromptUpdate) {
                displayMostRecentSearchResults();
            }

            // Update collection flag UI
            updateCollectionFlagUI();

            // Update collection hidden UI
            updateCollectionHiddenUI();

            // Update editability based on ownership + hidden state
            updateCollectionEditability();
        }

        // Display the most recent search results from the active collection
        async function displayMostRecentSearchResults() {
            if (!activeCollectionData) return;

            const searchHistory = activeCollectionData.search_history || [];
            if (searchHistory.length === 0) return;

            // Get the most recent search (first in array, ordered by created_at descending)
            const mostRecentSearch = searchHistory[0];
            if (!mostRecentSearch.result_references || mostRecentSearch.result_references.length === 0) {
                return;
            }

            const resultsDiv = document.getElementById('results');
            if (!resultsDiv) return;

            // Initialize TaxonResultWidget if available
            if (typeof TaxonResultWidget !== 'undefined') {
                TaxonResultWidget.init({ apiBase: API_BASE });
            } else {
                console.warn('TaxonResultWidget not loaded');
                return;
            }

            // Show loading state
            resultsDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <span style="color: #666;">Loading ${mostRecentSearch.result_references.length} results from collection...</span>
                    <span style="color: #667eea; font-size: 0.9em;">From: ${escapeHtml(mostRecentSearch.prompt.substring(0, 50))}${mostRecentSearch.prompt.length > 50 ? '...' : ''}</span>
                </div>
            `;

            try {
                // Render results using the widget (it will fetch full data for each taxon_id)
                await TaxonResultWidget.renderAll(resultsDiv, mostRecentSearch.result_references, {
                    showJson: true,
                    descriptionLength: 500,
                    clear: false  // Don't clear the header we just added
                });

                // Update header after results are loaded
                const headerHtml = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <span style="color: #666;">Found ${mostRecentSearch.result_references.length} results</span>
                        <span style="color: #667eea; font-size: 0.9em;">From collection search: "${escapeHtml(mostRecentSearch.prompt.substring(0, 50))}${mostRecentSearch.prompt.length > 50 ? '...' : ''}"</span>
                    </div>
                `;
                resultsDiv.insertAdjacentHTML('afterbegin', headerHtml);
            } catch (error) {
                console.error('Error loading search results:', error);
                resultsDiv.innerHTML = `<div class="no-results">Failed to load search results: ${escapeHtml(error.message)}</div>`;
            }
        }

        // Hide collection-related UI elements
        function hideCollectionUI() {
            const infoDiv = document.getElementById('collectionInfo');
            if (infoDiv) infoDiv.style.display = 'none';

            const descNote = document.getElementById('descriptionNote');
            if (descNote) descNote.style.display = 'none';

            const nomenclatureSection = document.getElementById('nomenclatureSection');
            if (nomenclatureSection) nomenclatureSection.style.display = 'none';

            const identifiersSection = document.getElementById('identifiersSection');
            if (identifiersSection) identifiersSection.style.display = 'none';

            const discussionSection = document.getElementById('discussionSection');
            if (discussionSection) discussionSection.style.display = 'none';

            const flagArea = document.getElementById('collectionFlagArea');
            if (flagArea) flagArea.style.display = 'none';

            const hiddenNotice = document.getElementById('collectionHiddenNotice');
            if (hiddenNotice) hiddenNotice.style.display = 'none';

            // Restore fields to editable state
            const prompt = document.getElementById('prompt');
            if (prompt) prompt.removeAttribute('readonly');
            const nomenclatureInput = document.getElementById('nomenclatureInput');
            if (nomenclatureInput) nomenclatureInput.removeAttribute('readonly');
            const searchButton = document.getElementById('searchButton');
            if (searchButton) searchButton.disabled = false;

            // Restore add-identifier form visibility
            const addForm = document.querySelector('.add-identifier-form');
            if (addForm) addForm.style.display = '';
        }

        // Update collection flag UI based on activeCollectionData
        function updateCollectionFlagUI() {
            if (!activeCollectionData) return;
            const flagArea = document.getElementById('collectionFlagArea');
            if (!flagArea) return;

            const flaggedBy = activeCollectionData.flagged_by || [];
            const flagCount = flaggedBy.length;
            const isFlaggedByMe = flaggedBy.includes(CURRENT_USER_ID);

            flagArea.style.display = 'inline';

            const flagLink = document.getElementById('collectionFlagLink');
            if (isFlaggedByMe) {
                flagLink.textContent = 'Flagged';
                flagLink.classList.add('flag-active');
                flagLink.onclick = function() { return false; };
            } else {
                flagLink.textContent = 'Flag';
                flagLink.classList.remove('flag-active');
                flagLink.onclick = function() { flagCollection(); return false; };
            }

            const badge = document.getElementById('collectionFlagBadge');
            if (IS_ADMIN && flagCount > 0) {
                badge.textContent = 'flagged (' + flagCount + ')';
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }

            const unflagLink = document.getElementById('collectionUnflagLink');
            unflagLink.style.display = (IS_ADMIN && flagCount > 0) ? 'inline' : 'none';
        }

        async function flagCollection() {
            if (!activeCollectionId) return;
            if (!window.confirm('Flag this collection as inappropriate?\n\nOnly an admin can remove this flag.')) return;
            const resp = await fetch(`${API_BASE}/api/collections/${activeCollectionId}/flag/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': getCSRFToken() }
            });
            if (resp.ok) {
                activeCollectionData = await resp.json();
                updateCollectionFlagUI();
            }
        }

        async function unflagCollection() {
            if (!activeCollectionId) return;
            const resp = await fetch(`${API_BASE}/api/collections/${activeCollectionId}/flag/`, {
                method: 'DELETE',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': getCSRFToken() }
            });
            if (resp.ok) {
                activeCollectionData = await resp.json();
                updateCollectionFlagUI();
            }
        }

        // Update collection hidden UI based on activeCollectionData
        function updateCollectionHiddenUI() {
            if (!activeCollectionData) return;
            const isHidden = activeCollectionData.hidden || false;
            const notice = document.getElementById('collectionHiddenNotice');
            const hideLink = document.getElementById('collectionHideLink');
            const unhideLink = document.getElementById('collectionUnhideLink');

            // Hide/Unhide links (admin only)
            if (hideLink) {
                hideLink.style.display = (IS_ADMIN && !isHidden) ? 'inline' : 'none';
            }
            if (unhideLink) {
                unhideLink.style.display = (IS_ADMIN && isHidden) ? 'inline' : 'none';
            }

            // Hidden notice (visible to owner when hidden, not to admin)
            if (notice) {
                notice.style.display = (isHidden && !IS_ADMIN) ? 'inline' : 'none';
            }
        }

        // Update editability based on ownership AND hidden state.
        // Non-owners (who are not admin) get read-only access to everything
        // except the Discussion section.
        function updateCollectionEditability() {
            if (!activeCollectionData) return;
            const isOwner = activeCollectionData.owner_username === CURRENT_USERNAME;
            const isHidden = activeCollectionData.hidden || false;
            const canEdit = (isOwner || IS_ADMIN) && (!isHidden || IS_ADMIN);

            const prompt = document.getElementById('prompt');
            const nomenclatureInput = document.getElementById('nomenclatureInput');
            const searchButton = document.getElementById('searchButton');
            if (!canEdit) {
                if (prompt) prompt.setAttribute('readonly', '');
                if (nomenclatureInput) nomenclatureInput.setAttribute('readonly', '');
                if (searchButton) searchButton.disabled = true;
            } else {
                if (prompt) prompt.removeAttribute('readonly');
                if (nomenclatureInput) nomenclatureInput.removeAttribute('readonly');
                if (searchButton) searchButton.disabled = false;
            }

            // Show/hide identifier add form
            const addForm = document.querySelector('.add-identifier-form');
            if (addForm) addForm.style.display = canEdit ? '' : 'none';

            // Show/hide identifier delete buttons
            document.querySelectorAll('#identifiersList .delete-btn').forEach(btn => {
                btn.style.display = canEdit ? '' : 'none';
            });
        }

        async function hideCollectionAction() {
            if (!activeCollectionId) return;
            if (!window.confirm('Hide this collection?\n\nThe owner will only be able to delete it.')) return;
            const resp = await fetch(`${API_BASE}/api/collections/${activeCollectionId}/hide/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': getCSRFToken() }
            });
            if (resp.ok) {
                activeCollectionData = await resp.json();
                updateCollectionHiddenUI();
            }
        }

        async function unhideCollectionAction() {
            if (!activeCollectionId) return;
            const resp = await fetch(`${API_BASE}/api/collections/${activeCollectionId}/hide/`, {
                method: 'DELETE',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': getCSRFToken() }
            });
            if (resp.ok) {
                activeCollectionData = await resp.json();
                updateCollectionHiddenUI();
            }
        }

        // Save nomenclature to collection (debounced, called from input handler)
        // Also records a nomenclature change event in the history when value changes
        async function saveNomenclature(value) {
            if (!activeCollectionId || !activeCollectionData) return;

            // Only the owner (or admin) may save nomenclature
            const isOwner = activeCollectionData.owner_username === CURRENT_USERNAME;
            if (!isOwner && !IS_ADMIN) return;

            // Track previous value to detect real changes
            const previousValue = activeCollectionData.nomenclature || '';
            const valueChanged = value !== previousValue;
            console.log('saveNomenclature:', { value, previousValue, valueChanged });

            try {
                const response = await fetch(`${API_BASE}/api/collections/${activeCollectionId}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        name: activeCollectionData.name,
                        description: activeCollectionData.description,
                        nomenclature: value
                    })
                });

                if (response.ok) {
                    // Update local data
                    activeCollectionData.nomenclature = value;
                    // Show saved indicator
                    const indicator = document.getElementById('nomenclatureSaveIndicator');
                    if (indicator) {
                        indicator.classList.add('show');
                        setTimeout(() => indicator.classList.remove('show'), 2000);
                    }

                    // Record nomenclature change event in history if value actually changed
                    if (valueChanged && value.trim()) {
                        console.log('Recording nomenclature change event:', value);
                        try {
                            const historyResponse = await fetch(`${API_BASE}/api/collections/${activeCollectionId}/nomenclature-changes/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCSRFToken()
                                },
                                credentials: 'same-origin',
                                body: JSON.stringify({ nomenclature: value })
                            });
                            if (historyResponse.ok) {
                                console.log('Nomenclature change event recorded successfully');
                            } else {
                                const errorData = await historyResponse.json().catch(() => ({}));
                                console.warn('Nomenclature change API error:', historyResponse.status, errorData);
                            }
                        } catch (historyError) {
                            console.warn('Could not record nomenclature change:', historyError);
                        }
                    } else {
                        console.log('Skipping nomenclature change event:', { valueChanged, valueTrimmed: value.trim() });
                    }
                }
            } catch (error) {
                console.warn('Could not save nomenclature:', error);
            }
        }

        // Copy a title to the nomenclature field (called from search results)
        function copyToNomenclature(title) {
            const nomenclatureInput = document.getElementById('nomenclatureInput');
            if (!nomenclatureInput) {
                console.warn('Nomenclature input not found');
                return false;
            }

            nomenclatureInput.value = title;
            // Trigger save
            saveNomenclature(title);
            // Scroll to show the nomenclature field
            nomenclatureInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Brief highlight effect
            nomenclatureInput.style.backgroundColor = '#e8f5e9';
            setTimeout(() => {
                nomenclatureInput.style.backgroundColor = '';
            }, 1000);
            return true;
        }

        // Handler for inline copy button (used in fallback rendering)
        function handleCopyToNomenclature(btn) {
            const title = btn.getAttribute('data-title');
            const success = copyToNomenclature(title);
            if (success) {
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy';
                    btn.classList.remove('copied');
                }, 2000);
            }
        }

        // Update the identifiers display
        function updateIdentifiersDisplay() {
            const list = document.getElementById('identifiersList');
            if (!list || !activeCollectionData) return;

            const identifiers = activeCollectionData.external_identifiers || [];
            const isOwner = activeCollectionData.owner_username === CURRENT_USERNAME;
            const canEdit = (isOwner || IS_ADMIN) && (!activeCollectionData.hidden || IS_ADMIN);

            if (identifiers.length === 0) {
                list.innerHTML = '<div class="no-identifiers">No identifiers added yet</div>';
                return;
            }

            list.innerHTML = identifiers.map(i => {
                // For fungarium identifiers, show the fungarium code and name
                let displayType = i.identifier_type_name;
                if (i.fungarium_code) {
                    displayType = i.fungarium_code;
                    if (i.fungarium_name) {
                        displayType += ` (${i.fungarium_name})`;
                    }
                }

                return `
                    <div class="identifier-row">
                        <div style="display: flex; align-items: center;">
                            <span class="identifier-type-badge">${escapeHtml(displayType)}</span>
                            <span class="identifier-value">
                                ${i.url ? `<a href="${escapeHtml(i.url)}" target="_blank">${escapeHtml(i.value)}</a>` : escapeHtml(i.value)}
                            </span>
                        </div>
                        ${canEdit ? `<button class="delete-btn" onclick="deleteIdentifier(${i.id})">Delete</button>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Add a new identifier
        async function addIdentifier() {
            if (!activeCollectionId) {
                alert('Please select a collection first');
                return;
            }

            const typeCode = document.getElementById('newIdentifierType').value;
            const fungariumCode = document.getElementById('newFungariumCode').value;
            const value = document.getElementById('newIdentifierValue').value.trim();

            if (!typeCode || !value) {
                alert('Please select a type and enter a value');
                return;
            }

            // For fungarium identifiers, require fungarium code
            if (typeCode === 'fungarium' && !fungariumCode) {
                alert('Please select a fungarium');
                return;
            }

            // Build request body
            const requestBody = {
                identifier_type_code: typeCode,
                value: value
            };

            // Include fungarium_code if this is a fungarium identifier
            if (typeCode === 'fungarium' && fungariumCode) {
                requestBody.fungarium_code = fungariumCode;
            }

            try {
                const response = await fetch(`${API_BASE}/api/collections/${activeCollectionId}/identifiers/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to add identifier');
                }

                // Clear form
                document.getElementById('newIdentifierType').value = '';
                document.getElementById('newFungariumCode').value = '';
                document.getElementById('newFungariumSelectContainer').style.display = 'none';
                document.getElementById('newIdentifierValue').value = '';

                // Reload collection to get updated identifiers
                await loadActiveCollection();
                showSuccess('Identifier added!');

            } catch (error) {
                showError(error.message);
            }
        }

        // Delete an identifier
        async function deleteIdentifier(identifierId) {
            if (!activeCollectionId) return;

            if (!confirm('Delete this identifier?')) return;

            try {
                const response = await fetch(`${API_BASE}/api/collections/${activeCollectionId}/identifiers/${identifierId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete identifier');
                }

                await loadActiveCollection();
                showSuccess('Identifier deleted');

            } catch (error) {
                showError(error.message);
            }
        }

        // Update collections dropdown menu in navbar
        async function updateCollectionsMenu() {
            const menuList = document.getElementById('collectionsMenuList');
            if (!menuList) return;

            try {
                const response = await fetch(`${API_BASE}/api/collections/`, {
                    credentials: 'same-origin'
                });
                const data = await response.json();
                const collections = data.collections || [];

                if (collections.length === 0) {
                    menuList.innerHTML = '<div class="no-collections">No collections yet. Create one to save your searches!</div>';
                    return;
                }

                menuList.innerHTML = collections.slice(0, 5).map(c => `
                    <a href="${API_BASE}/collections/${c.collection_id}/" class="collection-menu-item" style="display: block; text-decoration: none; color: inherit;${c.hidden ? ' opacity: 0.5;' : ''}">
                        <div class="collection-name">${c.hidden ? ' ' : ''}${escapeHtml(c.name)}</div>
                        <div class="collection-meta">${c.search_count || 0} searches, ${c.identifier_count || 0} identifiers</div>
                    </a>
                `).join('');

                if (collections.length > 5) {
                    menuList.innerHTML += `<div class="collection-menu-item" style="text-align: center; color: #666;">
                        <a href="${API_BASE}/collections/">View all ${collections.length} collections</a>
                    </div>`;
                }
            } catch (error) {
                console.error('Error loading collections menu:', error);
                menuList.innerHTML = '<div class="no-collections">Error loading collections</div>';
            }
        }

        // Toggle collections menu
        function toggleCollectionsMenu() {
            const menu = document.getElementById('collectionsMenu');
            menu.classList.toggle('show');
            // Close settings menu when opening collections
            document.getElementById('settingsMenu')?.classList.remove('show');
        }

        // Toggle settings menu
        function toggleSettingsMenu() {
            const menu = document.getElementById('settingsMenu');
            menu.classList.toggle('show');
            // Close collections menu when opening settings
            document.getElementById('collectionsMenu')?.classList.remove('show');
        }

        // Load user settings from API (or sessionStorage for guests)
        async function loadUserSettings() {
            if (IS_AUTHENTICATED) {
                try {
                    const resp = await fetch(`${API_BASE}/api/user-settings/`, { credentials: 'same-origin' });
                    if (resp.ok) {
                        const data = await resp.json();
                        const cb = document.getElementById('receiveAdminSummary');
                        if (cb) cb.checked = !!data.receive_admin_summary;
                        if (data.results_per_page) {
                            resultsPerPage = data.results_per_page;
                            const rppInput = document.getElementById('resultsPerPage');
                            if (rppInput) rppInput.value = resultsPerPage;
                        }
                        if (data.default_k) {
                            const kInput = document.getElementById('k');
                            if (kInput) kInput.value = data.default_k;
                        }
                    }
                } catch (e) {
                    console.error('Failed to load user settings:', e);
                }
            } else {
                const stored = sessionStorage.getItem('skol_results_per_page');
                if (stored) {
                    resultsPerPage = parseInt(stored, 10) || 10;
                    const rppInput = document.getElementById('resultsPerPage');
                    if (rppInput) rppInput.value = resultsPerPage;
                }
            }
        }

        // Save admin summary preference to API
        async function saveAdminSummaryPref() {
            const cb = document.getElementById('receiveAdminSummary');
            if (!cb) return;
            try {
                await fetch(`${API_BASE}/api/user-settings/`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
                    credentials: 'same-origin',
                    body: JSON.stringify({ receive_admin_summary: cb.checked })
                });
            } catch (e) {
                console.error('Failed to save admin summary preference:', e);
            }
        }

        // Save results per page setting
        function saveResultsPerPage(value) {
            const val = Math.max(5, Math.min(50, parseInt(value, 10) || 10));
            resultsPerPage = val;

            if (IS_AUTHENTICATED) {
                fetch(`${API_BASE}/api/user-settings/`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
                    credentials: 'same-origin',
                    body: JSON.stringify({ results_per_page: val })
                }).catch(e => console.error('Failed to save results per page:', e));
            } else {
                sessionStorage.setItem('skol_results_per_page', val);
            }

            // Re-render if results are displayed
            if (currentSearchData && currentSearchData.results && currentSearchData.results.length > 0) {
                currentPage = 1;
                renderCurrentPage();
            }
        }

        // Mobile menu functions
        function openMobileMenu() {
            document.getElementById('mobileMenu').classList.add('show');
            document.getElementById('mobileMenuOverlay').classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeMobileMenu() {
            document.getElementById('mobileMenu').classList.remove('show');
            document.getElementById('mobileMenuOverlay').classList.remove('show');
            document.body.style.overflow = ''; // Restore scrolling
        }

        // Save guest description to localStorage before navigating to login/register
        // This ensures the description is saved even if blur event doesn't fire on mobile
        function saveGuestDescriptionBeforeNav() {
            if (typeof GuestCollection !== 'undefined') {
                const promptTextarea = document.getElementById('prompt');
                if (promptTextarea && promptTextarea.value.trim()) {
                    GuestCollection.updateDescription(promptTextarea.value);
                    console.log('Saved guest description before navigation');
                }
            }
        }

        // Close dropdown menus when clicking outside
        document.addEventListener('click', function(event) {
            const collectionsDropdown = document.querySelector('.collections-dropdown');
            if (collectionsDropdown && !collectionsDropdown.contains(event.target)) {
                document.getElementById('collectionsMenu')?.classList.remove('show');
            }
            const settingsDropdown = document.querySelector('.settings-dropdown');
            if (settingsDropdown && !settingsDropdown.contains(event.target)) {
                document.getElementById('settingsMenu')?.classList.remove('show');
            }
        });

        // Show new collection modal
        function showNewCollectionModal() {
            document.getElementById('collectionsMenu')?.classList.remove('show');
            document.getElementById('newCollectionModal').classList.add('show');
            document.getElementById('collectionName').focus();
        }

        // Hide new collection modal
        function hideNewCollectionModal() {
            document.getElementById('newCollectionModal').classList.remove('show');
            document.getElementById('newCollectionForm').reset();
        }

        // Create new collection
        document.getElementById('newCollectionForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('collectionName').value;
            const nomenclature = document.getElementById('collectionNomenclature').value;
            const notes = document.getElementById('collectionNotes').value;
            const embargoInput = document.getElementById('collectionEmbargo').value;
            // Preserve any existing description text - it becomes part of the new collection
            const description = document.getElementById('prompt').value;

            // Build request body
            const body = { name, notes, description, nomenclature };
            if (embargoInput) {
                // Convert date to ISO datetime (end of day in UTC)
                body.embargo_until = new Date(embargoInput + 'T23:59:59Z').toISOString();
            }

            try {
                const response = await fetch(`${API_BASE}/api/collections/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create collection');
                }

                hideNewCollectionModal();
                showSuccess(`Collection "${name}" created successfully!`);

                // Refresh the collections dropdown and navbar menu
                if (window.refreshCollectionSelect) {
                    await window.refreshCollectionSelect();
                }
                await updateCollectionsMenu();

                // Select the newly created collection
                const collectionInput = document.getElementById('activeCollection');
                if (collectionInput) {
                    collectionInput.value = data.collection_id;
                    collectionInput.dispatchEvent(new Event('change', { bubbles: true }));
                    await onCollectionChange(data.collection_id);
                }

            } catch (error) {
                showError(error.message);
            }
        });

        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Show guest collection notice (for non-authenticated users)
        function showGuestCollectionNotice() {
            // Only show notice once per session to avoid being annoying
            if (sessionStorage.getItem('guest_collection_notice_shown')) {
                return;
            }

            const notice = document.createElement('div');
            notice.className = 'guest-notice';
            notice.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <strong>Search saved locally!</strong>
                        <span>Create an account to save your collection permanently.</span>
                    </div>
                    <div>
                        <a href="${API_BASE}/accounts/register/" class="btn-small" style="margin-right: 8px;">Sign Up</a>
                        <button type="button" class="dismiss-btn" onclick="this.parentElement.parentElement.parentElement.remove()">Dismiss</button>
                    </div>
                </div>
            `;
            notice.style.cssText = `
                background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
                border: 1px solid #81c784;
                padding: 15px 20px;
                border-radius: 8px;
                margin-bottom: 20px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            `;

            const resultsDiv = document.getElementById('results');
            resultsDiv.insertBefore(notice, resultsDiv.firstChild);

            sessionStorage.setItem('guest_collection_notice_shown', 'true');
        }

        // Handle form submission
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const prompt = document.getElementById('prompt').value;
            const embedding = document.getElementById('embedding').value;
            const k = parseInt(document.getElementById('k').value);

            // Show loading, hide error and results
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
            document.getElementById('results').innerHTML = '';
            document.getElementById('searchButton').disabled = true;

            try {
                // Save description and nomenclature to collection BEFORE search (owner/admin only)
                const canSave = activeCollectionData && (activeCollectionData.owner_username === CURRENT_USERNAME || IS_ADMIN);
                if (IS_AUTHENTICATED && activeCollectionId && prompt && canSave) {
                    try {
                        const nomenclatureInput = document.getElementById('nomenclatureInput');
                        const nomenclature = nomenclatureInput ? nomenclatureInput.value : activeCollectionData.nomenclature;
                        await fetch(`${API_BASE}/api/collections/${activeCollectionId}/`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()
                            },
                            credentials: 'same-origin',
                            body: JSON.stringify({
                                name: activeCollectionData.name,
                                description: prompt,
                                nomenclature: nomenclature
                            })
                        });
                        // Update local data
                        activeCollectionData.description = prompt;
                        activeCollectionData.nomenclature = nomenclature;
                    } catch (descError) {
                        console.warn('Could not save description to collection:', descError);
                    }
                } else if (!IS_AUTHENTICATED && prompt && typeof GuestCollection !== 'undefined') {
                    // Save to guest collection (localStorage) for non-authenticated users
                    GuestCollection.updateDescription(prompt);
                }

                const searchBody = {
                    prompt: prompt,
                    embedding_name: embedding,
                    k: k
                };
                const nomenPattern = document.getElementById('nomenclaturePattern').value.trim();
                if (nomenPattern) {
                    searchBody.nomenclature_pattern = nomenPattern;
                }

                const response = await fetch(`${API_BASE}/api/search/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(searchBody)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Search failed');
                }

                displayResults(data);

                // Extract taxa IDs for feature selection widget
                if (data.results && data.results.length > 0) {
                    const taxaIds = data.results.map(r => r.taxon_id).filter(Boolean);
                    if (taxaIds.length > 0) {
                        const cookieData = {
                            taxa_ids: taxaIds,
                            prompt: prompt.substring(0, 50),
                            timestamp: Date.now()
                        };
                        document.cookie = 'skol_deeper_search=' +
                            encodeURIComponent(JSON.stringify(cookieData)) +
                            '; max-age=3600; path=/; SameSite=Lax';
                        document.dispatchEvent(
                            new CustomEvent('deeper-search-complete', {
                                detail: cookieData
                            })
                        );
                    }
                }

                // Save search results to history (description already saved above)
                if (IS_AUTHENTICATED && activeCollectionId && data.results && data.results.length > 0) {
                    await saveSearchResultsToHistory(data);
                } else if (!IS_AUTHENTICATED && data.results && data.results.length > 0 && typeof GuestCollection !== 'undefined') {
                    // Save to guest collection for non-authenticated users
                    GuestCollection.addSearch(data);
                    showGuestCollectionNotice();
                }

            } catch (error) {
                document.getElementById('error').textContent = error.message;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchButton').disabled = false;
            }
        });

        // Nomenclature regex search
        async function nomenclatureSearch() {
            const pattern = document.getElementById('nomenclaturePattern').value.trim();
            if (!pattern) return;
            const embedding = document.getElementById('embedding').value;
            const limit = parseInt(document.getElementById('nomenclatureLimit').value) || 20;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
            document.getElementById('results').innerHTML = '';
            document.getElementById('nomenclatureSearchButton').disabled = true;

            try {
                const params = new URLSearchParams({
                    pattern: pattern,
                    embedding_name: embedding,
                    limit: limit
                });
                const response = await fetch(`${API_BASE}/api/search/nomenclature/?${params}`, {
                    credentials: 'same-origin'
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Search failed');
                displayResults(data);
            } catch (error) {
                document.getElementById('error').textContent = error.message;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('nomenclatureSearchButton').disabled = false;
            }
        }

        // Enter key on nomenclature pattern input triggers search
        document.getElementById('nomenclaturePattern').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                nomenclatureSearch();
            }
        });

        // Save search results to collection history (description is saved separately before search)
        async function saveSearchResultsToHistory(searchData) {
            if (!activeCollectionId || !searchData) return;

            try {
                // Add to search history
                const response = await fetch(`${API_BASE}/api/collections/${activeCollectionId}/searches/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        prompt: searchData.prompt,
                        embedding_name: searchData.embedding_name,
                        k: searchData.k,
                        result_references: searchData.results.map(r => ({
                            similarity: r.Similarity,
                            title: r.Title,
                            // Store taxon_id for widget retrieval, fall back to PDFDocId
                            taxon_id: r.taxon_id || r.PDFDocId || null,
                            // Also store PDF source info for direct linking
                            pdf_db_name: r.PDFDbName || null,
                            pdf_doc_id: r.PDFDocId || null
                        }))
                    })
                });

                if (!response.ok) {
                    const data = await response.json();
                    console.error('Failed to save search to history:', data.error);
                    return;
                }

                // Update local collection data (skip overwriting prompt)
                await loadActiveCollection();
                showCollectionUI(true);

            } catch (error) {
                console.error('Error saving search to collection:', error);
            }
        }

        // Display search results with client-side pagination
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            currentSearchData = data;
            currentPage = 1;

            if (!data.results || data.results.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">No results found</div>';
                return;
            }

            if (typeof TaxonResultWidget !== 'undefined') {
                TaxonResultWidget.init({ apiBase: API_BASE });
            }

            renderCurrentPage();
        }

        // Render the current page of results
        function renderCurrentPage() {
            const resultsDiv = document.getElementById('results');
            const data = currentSearchData;
            if (!data || !data.results) return;

            const total = data.results.length;
            const totalPages = Math.ceil(total / resultsPerPage);
            currentPage = Math.max(1, Math.min(currentPage, totalPages));
            const start = (currentPage - 1) * resultsPerPage;
            const end = Math.min(start + resultsPerPage, total);
            const pageResults = data.results.slice(start, end);

            // Header with count and collection status
            let collectionStatus = '';
            if (IS_AUTHENTICATED && activeCollectionId) {
                collectionStatus = `<span style="color: #667eea; font-size: 0.9em;">Saved to collection</span>`;
            }

            resultsDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <span style="color: #666;">Found ${total} results (showing ${start + 1}\u2013${end})</span>
                    ${collectionStatus}
                </div>
            `;

            // Render result cards for current page
            pageResults.forEach((result, i) => {
                const globalIndex = start + i;
                if (typeof TaxonResultWidget !== 'undefined') {
                    const card = TaxonResultWidget.createCard(result, {
                        index: globalIndex,
                        showJson: true,
                        descriptionLength: 500
                    });
                    card.className = 'result-card';
                    resultsDiv.appendChild(card);
                } else {
                    // Fallback rendering
                    const card = document.createElement('div');
                    card.className = 'result-card';

                    const hasSimilarity = result.Similarity != null;
                    const similarity = hasSimilarity ? (result.Similarity * 100).toFixed(1) : null;

                    let pdfLink = '';
                    let pageFragment = '';
                    if (result.PDFLabel) {
                        pageFragment = `#page=${encodeURIComponent(result.PDFLabel)}`;
                    } else if (result.PDFPage) {
                        pageFragment = `#page=${result.PDFPage}`;
                    }

                    if (result.PDFDbName && result.PDFDocId) {
                        let pdfUrl = `${API_BASE}/pdf/?db=${encodeURIComponent(result.PDFDbName)}&doc_id=${encodeURIComponent(result.PDFDocId)}`;
                        if (result.PDFPage) {
                            pdfUrl += `&page=${result.PDFPage}`;
                        }
                        pdfUrl += pageFragment;
                        pdfLink = `<a href="${pdfUrl}" class="view-pdf-btn" target="_blank">View PDF</a>`;
                    }

                    const resultTitle = result.Title || 'Untitled';
                    const showCopyBtn = IS_AUTHENTICATED && document.getElementById('nomenclatureInput');
                    const copyBtnHtml = showCopyBtn
                        ? `<button type="button" class="copy-nomenclature-btn" data-title="${escapeHtml(resultTitle)}" onclick="handleCopyToNomenclature(this)">Copy</button>`
                        : '';

                    card.innerHTML = `
                        <div class="result-header">
                            <div class="result-title">${escapeHtml(result.Title || 'Untitled')}${copyBtnHtml}</div>
                            ${hasSimilarity ? `<div class="similarity-badge">${similarity}%</div>` : '<div class="similarity-badge" style="background: #28a745;">Name match</div>'}
                        </div>
                        <div class="result-meta">
                            ${result.Feed ? `<div class="meta-item"><span class="meta-label">Feed:</span>${escapeHtml(typeof result.Feed === 'object' ? JSON.stringify(result.Feed) : result.Feed)}</div>` : ''}
                            ${result.PDFPage ? `<div class="meta-item"><span class="meta-label">PDF Page:</span>${result.PDFPage}</div>` : ''}
                            ${result.LineNumber ? `<div class="meta-item"><span class="meta-label">Line:</span>${result.LineNumber}</div>` : ''}
                        </div>
                        ${result.Description ? `<div class="result-description">${escapeHtml(result.Description).substring(0, 500)}${result.Description.length > 500 ? '...' : ''}</div>` : ''}
                        <div class="result-actions">
                            ${pdfLink}
                            ${result.URL ? `<a href="${escapeHtml(result.URL)}${pageFragment}" target="_blank" class="view-pdf-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">View Source</a>` : ''}
                            <button class="toggle-json" onclick="toggleJson(${globalIndex})">Show Full JSON</button>
                        </div>
                        ${result.taxon_id ? `
                        <div class="source-context-viewers" style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <div data-source-context-viewer
                                 data-taxa-id="${escapeHtml(result.taxon_id)}"
                                 data-field="nomenclature"
                                 data-api-base-url="${API_BASE}">
                            </div>
                            <div data-source-context-viewer
                                 data-taxa-id="${escapeHtml(result.taxon_id)}"
                                 data-field="description"
                                 data-api-base-url="${API_BASE}">
                            </div>
                        </div>
                        ` : ''}
                        <div id="json-${globalIndex}" class="result-json" style="display: none;">
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;

                    resultsDiv.appendChild(card);
                }
            });

            // Sticky pagination bar (only if more than one page)
            if (totalPages > 1) {
                resultsDiv.appendChild(createPaginationBar(totalPages));
            }

            // Initialize source context viewers after results are rendered
            document.dispatchEvent(new CustomEvent('source-context-init'));

            // Scroll to top of results on page change
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Create pagination navigation bar
        function createPaginationBar(totalPages) {
            const bar = document.createElement('div');
            bar.className = 'pagination-bar';

            const prev = document.createElement('button');
            prev.className = 'pagination-btn';
            prev.textContent = 'Prev';
            prev.disabled = (currentPage <= 1);
            prev.addEventListener('click', () => { currentPage--; renderCurrentPage(); });

            const info = document.createElement('span');
            info.className = 'pagination-info';
            info.textContent = `Page ${currentPage} of ${totalPages}`;

            const next = document.createElement('button');
            next.className = 'pagination-btn';
            next.textContent = 'Next';
            next.disabled = (currentPage >= totalPages);
            next.addEventListener('click', () => { currentPage++; renderCurrentPage(); });

            bar.appendChild(prev);
            bar.appendChild(info);
            bar.appendChild(next);
            return bar;
        }

        // Toggle JSON display
        function toggleJson(index) {
            const jsonDiv = document.getElementById(`json-${index}`);
            const button = event.target;

            if (jsonDiv.style.display === 'none') {
                jsonDiv.style.display = 'block';
                button.textContent = 'Hide Full JSON';
            } else {
                jsonDiv.style.display = 'none';
                button.textContent = 'Show Full JSON';
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Migrate guest collection for newly authenticated users
        async function migrateGuestCollection() {
            console.log('Index.html migration check...');
            console.log('IS_AUTHENTICATED:', IS_AUTHENTICATED);
            if (!IS_AUTHENTICATED) return;

            console.log('GuestCollection defined:', typeof GuestCollection !== 'undefined');
            if (typeof GuestCollection === 'undefined') return;

            const guestData = GuestCollection.get();
            console.log('Guest collection data:', guestData);
            console.log('Has data:', GuestCollection.hasData());
            if (!GuestCollection.hasData()) return;

            // Check if we've already SUCCESSFULLY migrated this session
            if (sessionStorage.getItem('guest_collection_migrated')) {
                console.log('Migration already completed this session');
                return;
            }
            console.log('Attempting migration to API...');

            try {
                console.log('Calling migrateToAccount with API_BASE:', API_BASE);
                const result = await GuestCollection.migrateToAccount(API_BASE, getCSRFToken);
                console.log('Migration result:', result);
                if (result && result.success) {
                    // Only set flag after SUCCESS
                    sessionStorage.setItem('guest_collection_migrated', 'true');
                    console.log('Guest collection migrated successfully:', result);
                    showSuccess(`Your saved searches have been imported to collection "${result.name}".`);
                    // Refresh collections menu and activate the new collection
                    await updateCollectionsMenu();
                    // Set the newly created collection as active (this loads the description into the textarea)
                    if (result.collection_id) {
                        await onCollectionChange(result.collection_id);
                    }
                } else {
                    console.log('Migration returned but not successful:', result);
                }
            } catch (error) {
                console.error('Failed to migrate guest collection:', error);
            }
        }

        // Load collection from URL parameter if present
        async function loadCollectionFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const collectionId = urlParams.get('collection');
            if (collectionId) {
                // Wait for React components to be ready (loaded after inline script)
                setTimeout(async () => {
                    // Set the hidden input value
                    const collectionInput = document.getElementById('activeCollection');
                    if (collectionInput) {
                        collectionInput.value = collectionId;
                        // Trigger the React component to update its display
                        collectionInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    // Load the collection (updateUrl=false to avoid re-setting the URL)
                    await onCollectionChange(collectionId, false);
                }, 100);
            }
        }

        // Load data when page loads
        loadEmbeddings();
        if (IS_AUTHENTICATED) {
            updateCollectionsMenu();
            loadUserSettings();
            // Check for guest collection to migrate
            migrateGuestCollection();
            // Load collection from URL if specified
            loadCollectionFromUrl();

            // Set up nomenclature auto-save with debounce
            let nomenclatureSaveTimeout = null;
            const nomenclatureInput = document.getElementById('nomenclatureInput');
            if (nomenclatureInput) {
                nomenclatureInput.addEventListener('input', function() {
                    if (nomenclatureSaveTimeout) clearTimeout(nomenclatureSaveTimeout);
                    nomenclatureSaveTimeout = setTimeout(() => {
                        saveNomenclature(this.value);
                    }, 1000); // Save after 1 second of no typing
                });

                // Also save on blur (when user clicks away)
                nomenclatureInput.addEventListener('blur', function() {
                    if (nomenclatureSaveTimeout) clearTimeout(nomenclatureSaveTimeout);
                    saveNomenclature(this.value);
                });

                // Listen for nomenclature updates from discussion widget
                document.addEventListener('nomenclature-updated', function(e) {
                    const newNomenclature = e.detail && e.detail.nomenclature;
                    if (newNomenclature) {
                        nomenclatureInput.value = newNomenclature;
                        if (activeCollectionData) {
                            activeCollectionData.nomenclature = newNomenclature;
                        }
                    }
                });
            }
        } else {
            loadUserSettings();
            // Auto-save description to guest collection for non-authenticated users
            // Use debounce to avoid saving on every keystroke
            let saveTimeout = null;
            const promptTextarea = document.getElementById('prompt');
            if (promptTextarea && typeof GuestCollection !== 'undefined') {
                // Load existing guest collection description if any
                const guestData = GuestCollection.get();
                if (guestData && guestData.description && !promptTextarea.value) {
                    promptTextarea.value = guestData.description;
                }

                // Save on input with debounce
                promptTextarea.addEventListener('input', function() {
                    if (saveTimeout) clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        if (this.value.trim()) {
                            GuestCollection.updateDescription(this.value);
                        }
                    }, 1000); // Save after 1 second of no typing
                });

                // Also save on blur (when user clicks away)
                promptTextarea.addEventListener('blur', function() {
                    if (saveTimeout) clearTimeout(saveTimeout);
                    if (this.value.trim()) {
                        GuestCollection.updateDescription(this.value);
                    }
                });
            }
        }
    </script>

    <!-- Code Block Component -->
    <script src="{% static 'js/code-block.bundle.js' %}"></script>

    <!-- Feature Selection Widget (includes Vocabulary Tree) -->
    <script src="{% static 'js/feature-selection.bundle.js' %}"></script>

    <!-- React Select Widgets -->
    <script src="{% static 'js/collection-select.bundle.js' %}"></script>
    <script src="{% static 'js/identifier-type-select.bundle.js' %}"></script>

    <!-- Fungarium Select Widget -->
    <script src="{% static 'js/fungarium-select.bundle.js' %}"></script>

    <!-- Source Context Viewer Widget -->
    <script src="{% static 'js/source-context.bundle.js' %}"></script>

    <!-- Discussion Widget -->
    <script src="{% static 'js/discussion.bundle.js' %}"></script>

    <!-- Taxon Result Widget -->
    <script src="{% static 'js/taxon-result-widget.js' %}"></script>
</body>
</html>
