##### services #####
services:

  # redisinsight
  redisinsight:
    image: redis/redisinsight:latest
    restart: always
    hostname: redisinsight
    environment:
      # Redis connection (TLS enabled)
      REDIS_PORT: "6379"
      REDIS_HOST: "redis"
      # RedisInsight web interface TLS
      RI_SERVER_TLS_KEY: /etc/letsencrypt/live/synoptickeyof.life/privkey.pem
      RI_SERVER_TLS_CERT: /etc/letsencrypt/live/synoptickeyof.life/fullchain.pem
    ports:
      - 5540:5540
    depends_on:
      - redis
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt
      - /etc/ssl:/etc/ssl

  # neo4j#
  neo4j:
    image: docker.io/neo4j:5.26 #5.15
    restart: always
    hostname: neo4j
    ports:
    #  - "7474:7474" #http
      - "7473:7473" #https
      - "7687:7687" #bolt
    environment:
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
      - NEO4J_AUTH=none
      - NEO4J_PLUGINS='["apoc", "graph-data-science"]'
      - NEO4J_dbms_memory_pagecache_size=1G
      # - "NEO4J_dbms_directories_plugins=/plugins"
      # - "NEO4J_dbms_security_procedures_unrestricted=algo.*,apoc.*,gds.*"
    volumes:
      - neo4j-data:/data
      # - ./neo4j-plugins:/plugins
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /etc/ssl:/etc/ssl:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - ./neo4j/conf:/var/lib/neo4j/conf:ro
      - ./neo4j/certificates:/var/lib/neo4j/certificates:ro

  #redis#
  redis:
    image: docker.io/redis:7.4
    restart: always
    hostname: redis
    entrypoint: ["/usr/local/bin/redis-entrypoint.sh"]
    env_file:
      - /home/skol/.skol_env
    ports:
      # TLS port exposed to localhost only (current setup)
      - "127.0.0.1:6380:6379"
      # Future: Uncomment to expose to other hosts for replication
      # - "6379:6379"
    volumes:
      - redis-data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf.template:ro
      - ./redis-entrypoint.sh:/usr/local/bin/redis-entrypoint.sh:ro
      # TLS certificates
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /etc/ssl:/etc/ssl:ro

  #couchdb_skol#
  couchdb_skol:
    image: couchdb:3.3.3
    restart: always
    ports:
      - "127.0.0.1:5984:5984"
      - "::1:5984:5984"
      - "6984:6984"
    secrets:
      - couchdb_password
    environment:
      # Use these variables to set up the admin user and password
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=/run/secrets/couchdb_password
    volumes:
      - /data/skol/couchdb/data:/opt/couchdb/data
      - /etc/letsencrypt:/etc/letsencrypt
      - /etc/ssl:/etc/ssl
      - ./couchdb/etc:/opt/couchdb/etc

##### volumes #####
volumes:
  neo4j-data:
    driver: local
  redis-data:
    driver: local
  metastore-postgresql:
    driver: local


##### networks #####
networks:
  default:
    name: local
    driver: bridge
    ipam:
      config:
        - subnet: 10.10.10.0/24
          gateway: 10.10.10.1

secrets:
  couchdb_password:
    file: /home/skol/.couchdb_password
