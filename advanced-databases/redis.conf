# SKOL Redis Configuration
# Secure configuration with TLS and authentication
#
# See https://redis.io/docs/management/security/ for security best practices.

################################## NETWORK #####################################

# Bind to all interfaces inside the container. TLS provides security.
# For localhost-only access (current setup), Docker handles port binding.
bind 0.0.0.0

# Disable non-TLS port
port 0

# TLS port (this is the only port that accepts connections)
tls-port 6379

# TCP backlog
tcp-backlog 511

# Client timeout (0 = disabled)
timeout 0

# TCP keepalive
tcp-keepalive 300

################################## TLS #########################################

# TLS Certificate Configuration
# These paths are mounted from the host via docker-compose
tls-cert-file /etc/letsencrypt/live/synoptickeyof.life/fullchain.pem
tls-key-file /etc/letsencrypt/live/synoptickeyof.life/privkey.pem

# CA certificate for verifying client certificates
tls-ca-cert-file /etc/ssl/certs/ca-certificates.crt

# Require TLS authentication from clients
# Options: yes (require client cert), no (optional client cert)
# For password-only auth, use 'no' - clients authenticate via ACL password
tls-auth-clients no

# Minimum TLS version (1.2 is the minimum secure version)
tls-protocols "TLSv1.2 TLSv1.3"

# Prefer server cipher order (more secure)
tls-prefer-server-ciphers yes

# Strong cipher suites only
tls-ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256

# TLS for replication links (for future multi-host setup)
tls-replication yes

# TLS for cluster bus (for future cluster setup)
tls-cluster yes

################################## SECURITY ####################################

# Require password authentication
# The password is set via environment variable substitution at container start
# Docker-compose sets REDIS_PASSWORD from the host environment
requirepass PLACEHOLDER_WILL_BE_SET_BY_ENTRYPOINT

# ACL configuration (Redis 6+)
# Default user is disabled for security - must use explicit admin account
user default off nopass ~* &* +@all

# Admin user with full access
# Password set via ACL SETUSER at runtime by entrypoint script
# This is a placeholder - actual password comes from REDIS_PASSWORD env var
user admin on >PLACEHOLDER_WILL_BE_SET_BY_ENTRYPOINT ~* &* +@all

# Disable dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command DEBUG ""

# Protected mode is disabled because:
# 1. TLS is required for all connections
# 2. Password authentication is required (admin user)
# 3. Docker networking makes connections appear non-local, blocking legitimate access
protected-mode no

################################## PERSISTENCE #################################

# Working directory
dir /data

# RDB persistence
dbfilename dump.rdb
rdbcompression yes
rdbchecksum yes

# RDB save triggers: save <seconds> <changes>
save 900 1
save 300 10
save 60 10000

# AOF persistence (more durable than RDB alone)
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

################################## MEMORY ######################################

# Eviction policy when memory limit is reached
# allkeys-lru: Remove least recently used keys first
maxmemory-policy allkeys-lru

# Maximum memory (uncomment and adjust based on available RAM)
# maxmemory 2gb

################################## LOGGING #####################################

# Log level: debug, verbose, notice, warning
loglevel notice

# Log to stdout (for Docker logging)
logfile ""

################################## CLIENTS #####################################

# Maximum number of connected clients
maxclients 10000

################################################################################
# FUTURE: REPLICATION CONFIGURATION
#
# To add a replica on another host:
# 1. Copy this config to the replica server
# 2. Uncomment and configure the replica settings below
# 3. Ensure TLS certificates are valid on both hosts
################################################################################

# # On the REPLICA server only, set the master address:
# replicaof <master-ip> 6379
#
# # Authentication to connect to master
# masterauth <master-password>
# masteruser admin
#
# # Replica serves stale data during sync (recommended for availability)
# replica-serve-stale-data yes
#
# # Replica is read-only (strongly recommended)
# replica-read-only yes
#
# # Replication timeout in seconds
# repl-timeout 60
#
# # Diskless replication (faster for slow disks, uses more bandwidth)
# repl-diskless-sync yes
# repl-diskless-sync-delay 5

################################################################################
# FUTURE: CLUSTER CONFIGURATION
#
# For Redis Cluster setup across multiple nodes:
################################################################################

# # Enable cluster mode
# cluster-enabled yes
#
# # Cluster configuration file (auto-managed by Redis)
# cluster-config-file nodes.conf
#
# # Cluster node timeout in milliseconds
# cluster-node-timeout 15000
#
# # Require full cluster coverage for writes
# cluster-require-full-coverage yes
